
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\Camara.cs
============================================================

using System.Text.Json.Serialization;

namespace MAVPC.Models
{
    public class Camara
    {
        // Mapeamos "cameraId" del JSON a nuestra propiedad Id
        [JsonPropertyName("cameraId")]
        public string Id { get; set; } = string.Empty;

        // Mapeamos "cameraName" -> Nombre
        [JsonPropertyName("cameraName")]
        public string Nombre { get; set; } = string.Empty;

        // Mapeamos "urlImage" -> UrlImagen
        // El '?' es importante porque en tu JSON a veces viene null
        [JsonPropertyName("urlImage")]
        public string? UrlImagen { get; set; }

        [JsonPropertyName("road")]
        public string Carretera { get; set; } = string.Empty;

        [JsonPropertyName("kilometer")]
        public string Kilometro { get; set; } = string.Empty;

        [JsonPropertyName("address")]
        public string Direccion { get; set; } = string.Empty;

        // Nota: Tus coordenadas vienen en formato UTM (números gigantes), 
        // no en latitud/longitud normal. Las guardamos como string por ahora.
        [JsonPropertyName("latitude")]
        public string Latitud { get; set; } = string.Empty;

        [JsonPropertyName("longitude")]
        public string Longitud { get; set; } = string.Empty;
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\Camara.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\Incidencia.cs
============================================================

using System;
using System.Text.Json.Serialization;

namespace MAVPC.Models
{
    public class Incidencia
    {
        // --- PROPIEDADES RAW (Coinciden 100% con tu JSON) ---

        [JsonPropertyName("incidenceId")]
        public string IncidenceId { get; set; } // CRÍTICO: En el JSON viene con comillas "", es string.

        [JsonPropertyName("incidenceType")]
        public string? IncidenceType { get; set; }

        [JsonPropertyName("incidenceLevel")]
        public string? IncidenceLevel { get; set; }

        [JsonPropertyName("road")]
        public string? Road { get; set; }

        [JsonPropertyName("cityTown")]
        public string? CityTown { get; set; }

        [JsonPropertyName("province")]
        public string? Province { get; set; }

        [JsonPropertyName("cause")]
        public string? Cause { get; set; }

        [JsonPropertyName("direction")]
        public string? Direction { get; set; }

        [JsonPropertyName("latitude")]
        public double? Latitude { get; set; }

        [JsonPropertyName("longitude")]
        public double? Longitude { get; set; }

        [JsonPropertyName("startDate")]
        public DateTime? StartDate { get; set; }


        // --- HELPERS VISUALES (Esto se mantiene igual, es lógica tuya) ---

        public string StatusColor
        {
            get
            {
                // Protección contra nulos
                var level = IncidenceLevel?.ToLower() ?? "";

                if (level.Contains("rojo") || level.Contains("red")) return "#FF003C"; // Rojo Neón
                if (level.Contains("negro") || level.Contains("black")) return "#000000";
                if (level.Contains("amarillo") || level.Contains("yellow")) return "#FFD700";
                if (level.Contains("verde") || level.Contains("green")) return "#00FF00";

                // Por defecto (blanco o desconocido) -> Cyan
                return "#00D4FF";
            }
        }

        public string IconKind
        {
            get
            {
                var t = IncidenceType?.ToLower() ?? "";
                var c = Cause?.ToLower() ?? "";

                if (t.Contains("obra") || c.Contains("obra") || c.Contains("mantenimiento")) return "Cone";
                if (t.Contains("accidente") || c.Contains("vuelco") || c.Contains("choque") || c.Contains("alcance")) return "CarCrash";
                if (c.Contains("avería") || c.Contains("averia")) return "CarWrench";
                if (c.Contains("gasoil") || c.Contains("aceite")) return "Oil";
                if (t.Contains("meteo") || c.Contains("nieve") || c.Contains("lluvia") || c.Contains("hielo")) return "WeatherPouring";
                if (t.Contains("evento")) return "CalendarStar";

                // Seguridad vial o genérico
                return "AlertCircle";
            }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\Incidencia.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\MapMarkerModel.cs
============================================================

namespace MAVPC.Models
{
    public class MapMarkerModel
    {
        // Usamos nombres cortos porque así lo espera el JavaScript que te pasé
        public double Lat { get; set; }
        public double Lon { get; set; }

        // Tipos aceptados por el JS: "camara", "incidencia", "obra"
        public string Type { get; set; } = "incidencia";

        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;

        // Propiedad opcional para guardar tu objeto original (Cámara o Incidencia real)
        // por si luego quieres hacer cosas avanzadas al recibir clics.
        public object? DataObject { get; set; }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\MapMarkerModel.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\SearchItems.cs
============================================================

namespace MAVPC.Models
{
    // Clase auxiliar para la lista desplegable del buscador
    public class SearchItem
    {
        public string Titulo { get; set; } = "";
        public string Subtitulo { get; set; } = "";
        public string Icono { get; set; } = "Magnify"; // Nombre del icono Material
        public string Color { get; set; } = "White";

        // Coordenadas para viajar al hacer clic
        public double Lat { get; set; }
        public double Lon { get; set; }

        // Guardamos el objeto original por si acaso
        public object? DataObject { get; set; }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\SearchItems.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\TrafficPoint.cs
============================================================

using System;

namespace MAVPC.Models
{
    public class TrafficPoint
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = "Cámara"; // Cámara, Sensor, Incidencia
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public string Status { get; set; } = "Fluido"; // Fluido, Denso, Retención, Cerrado
        public DateTime LastUpdate { get; set; } = DateTime.Now;

        // --- PROPIEDADES VISUALES (Helpers para la vista) ---

        // Icono según tipo
        public string IconKind
        {
            get
            {
                return Type switch
                {
                    "Cámara" => "Cctv",
                    "Sensor" => "AccessPoint",
                    "Incidencia" => "AlertCircle",
                    _ => "MapMarker"
                };
            }
        }

        // Color según estado
        public string StatusColor
        {
            get
            {
                return Status switch
                {
                    "Fluido" => "#00FF00",       // Verde
                    "Denso" => "#FFA500",        // Naranja
                    "Retención" => "#FF0000",    // Rojo
                    "Cerrado" => "#808080",      // Gris
                    _ => "#FFFFFF"
                };
            }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\TrafficPoint.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\Usuario.cs
============================================================

using System.Text.Json.Serialization;

namespace MAVPC.Models
{
    public class Usuario
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }

        [JsonPropertyName("usuario")]
        public string NombreUsuario { get; set; }

        [JsonPropertyName("email")]
        public string Email { get; set; }

        [JsonPropertyName("contrasena")]
        public string Contrasena { get; set; }

        [JsonPropertyName("urlImage")]
        public string UrlImage { get; set; }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Models\Usuario.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Converters\DashboardConverters.cs
============================================================

using MaterialDesignThemes.Wpf;
using System;
using System.Globalization;
using System.Windows.Data;
using System.Windows.Media;

namespace MAVPC.MVVM.Converters
{
    // 1. CONVERTER DE COLOR (Corregido para detectar Montaña)
    public class IncidentTypeToColorConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            // Pasamos a minúsculas para comparar fácil
            string type = value?.ToString()?.ToLower() ?? "";

            // CASO 1: ACCIDENTES (Rojo)
            if (type.Contains("accidente") || type.Contains("rojo") || type.Contains("grave") || type.Contains("cerrado"))
                return Brushes.Red;

            // CASO 2: OBRAS (Naranja)
            if (type.Contains("obra") || type.Contains("mantenimiento"))
                return Brushes.Orange;

            // CASO 3: TRÁFICO (Amarillo)
            if (type.Contains("retención") || type.Contains("tráfico") || type.Contains("lento"))
                return Brushes.Yellow;

            // CASO 4: NIEVE / PUERTOS (Blanco / Nieve) -> ¡ESTO ES LO QUE FALTABA!
            if (type.Contains("puerto") || type.Contains("montaña") || type.Contains("nieve") || type.Contains("hielo") || type.Contains("climatología"))
                return Brushes.White;

            // CASO 5: CÁMARAS (Si las usas aquí)
            if (type.Contains("cámara") || type.Contains("camara"))
                return new SolidColorBrush((Color)ColorConverter.ConvertFromString("#00D4FF")); // Cyan Tecnológico

            // DEFAULT: Si no sabemos qué es, ponemos el Cyan (o podrías poner Gris para que no destaque tanto)
            return new SolidColorBrush((Color)ColorConverter.ConvertFromString("#00D4FF"));
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture) => throw new NotImplementedException();
    }

    // 2. CONVERTER DE ICONO (Corregido para detectar Montaña)
    public class IncidentTypeToIconConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            string type = value?.ToString()?.ToLower() ?? "";

            if (type.Contains("accidente")) return PackIconKind.Car;
            if (type.Contains("obra") || type.Contains("mantenimiento")) return PackIconKind.Cone; // Cone (cono) es muy visual

            // Aquí añadimos "puerto" y "montaña" para que salga el icono de clima
            if (type.Contains("lluvia") || type.Contains("nieve") || type.Contains("hielo") || type.Contains("puerto") || type.Contains("montaña"))
                return PackIconKind.Snowflake; // O PackIconKind.Mountain si prefieres

            if (type.Contains("retención")) return PackIconKind.TrafficLight;

            return PackIconKind.AlertCircleOutline;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture) => throw new NotImplementedException();
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Converters\DashboardConverters.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Converters\MapConverters.cs
============================================================

using System;
using System.Globalization;
using System.Windows.Data;
using System.Windows.Media;
using MaterialDesignThemes.Wpf;

namespace MAVPC.MVVM.Converters
{
    // 1. INVERSE BOOL (Este se queda igual porque no está en el otro archivo)
    public class InverseBoolConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is bool booleanValue) return !booleanValue;
            return false;
        }
        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture) => throw new NotImplementedException();
    }

    // 2. ICON CONVERTER DEL MAPA (Renombrado a MapIncident...)
    public class MapIncidentTypeToIconConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            string type = (value as string ?? "").ToLower();

            if (type.Contains("camara")) return PackIconKind.Cctv;
            if (type.Contains("obra") || type.Contains("mantenimiento")) return PackIconKind.Construction;
            if (type.Contains("accidente") || type.Contains("grave")) return PackIconKind.Car;
            if (type.Contains("lluvia") || type.Contains("nieve") || type.Contains("hielo")) return PackIconKind.WeatherRainy;
            if (type.Contains("retención") || type.Contains("tráfico")) return PackIconKind.TrafficLight;

            return PackIconKind.AlertCircle;
        }
        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture) => throw new NotImplementedException();
    }

    // 3. COLOR CONVERTER DEL MAPA (Renombrado a MapIncident...)
    public class MapIncidentTypeToColorConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            string type = (value as string ?? "").ToLower();

            if (type.Contains("camara")) return Brushes.DodgerBlue;
            if (type.Contains("obra") || type.Contains("mantenimiento")) return Brushes.Orange;
            if (type.Contains("retención") || type.Contains("tráfico")) return Brushes.Yellow;

            return Brushes.Red;
        }
        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture) => throw new NotImplementedException();
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Converters\MapConverters.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\AddItemViewModel.cs
============================================================

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using MAVPC.Models;
using MAVPC.Services;
using System;
using System.Collections.ObjectModel;
using System.Globalization;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Data; // Necesario para el convertidor
using System.Windows.Media;

namespace MAVPC.MVVM.ViewModels
{
    public partial class AddItemViewModel : ObservableObject
    {
        public AddItemViewModel()
        {
            // Este constructor evita el crash de TargetInvocationException
            // cuando el XAML intenta previsualizar o cargar sin dependencias.
        }
        private readonly ITrafficService _trafficService;
        private readonly Action _closeWindow;

        // Estado de carga
        [ObservableProperty]
        [NotifyCanExecuteChangedFor(nameof(SubmitCommand))]
        private bool _isBusy;

        [ObservableProperty]
        [NotifyPropertyChangedFor(nameof(CurrentColor))]
        [NotifyPropertyChangedFor(nameof(IsCameraMode))]
        private bool _isCameraSelected = true;

        public bool IsCameraMode => IsCameraSelected;

        public Brush CurrentColor => IsCameraSelected
            ? new SolidColorBrush((Color)ColorConverter.ConvertFromString("#00FFFF")) // Cyan
            : new SolidColorBrush((Color)ColorConverter.ConvertFromString("#FF007F")); // Pink

        // Listas de autocompletado
        public ObservableCollection<string> SugerenciasCiudades { get; } = new()
        {
            "Irun", "Donostia", "Bilbao", "Vitoria-Gasteiz", "Errenteria",
            "Eibar", "Zarautz", "Hernani", "Tolosa", "Lasarte-Oria", "Pasaia"
        };

        public ObservableCollection<string> SugerenciasProvincias { get; } = new()
        {
            "Gipuzkoa", "Bizkaia", "Araba", "Navarra", "Lapurdi"
        };

        // Campos Cámara
        [ObservableProperty] private string _nombreCamara = string.Empty;
        [ObservableProperty] private string _urlCamara = string.Empty;
        [ObservableProperty] private string _carreteraCamara = string.Empty;
        [ObservableProperty] private string _kmCamara = string.Empty;
        [ObservableProperty] private string _direccionCamara = "Ubicación Sistema";
        [ObservableProperty] private string _latitudCamara = "43.3400";
        [ObservableProperty] private string _longitudCamara = "-1.7900";

        // Campos Incidencia
        [ObservableProperty] private string _typeIncidence = string.Empty;
        [ObservableProperty] private string _incidenceLevel = "Verde";
        [ObservableProperty] private string _roadIncidence = string.Empty;
        [ObservableProperty] private string _directionIncidence = "Ambos";
        [ObservableProperty] private string _descriptionIncidence = string.Empty;
        [ObservableProperty] private string _cityIncidence = "Irun";
        [ObservableProperty] private string _provinceIncidence = "Gipuzkoa";
        [ObservableProperty] private string _latitudInc = "43.3400";
        [ObservableProperty] private string _longitudInc = "-1.7900";

        public AddItemViewModel(ITrafficService trafficService, Action closeWindow)
        {
            _trafficService = trafficService;
            _closeWindow = closeWindow;
        }

        [RelayCommand] private void Close() => _closeWindow?.Invoke();
        [RelayCommand] private void SwitchMode(string mode) => IsCameraSelected = (mode == "Camera");

        private double ParseCoordinate(string input)
        {
            if (string.IsNullOrWhiteSpace(input)) return 0.0;
            string normalized = input.Replace(',', '.');
            if (double.TryParse(normalized, NumberStyles.Any, CultureInfo.InvariantCulture, out double result))
                return result;
            return 0.0;
        }

        [RelayCommand(CanExecute = nameof(CanSubmit))]
        private async Task Submit()
        {
            if (IsBusy) return;

            try
            {
                IsBusy = true;
                bool success = false;

                if (IsCameraSelected)
                {
                    if (string.IsNullOrWhiteSpace(NombreCamara)) { MessageBox.Show("Nombre obligatorio"); return; }

                    var newCam = new Camara
                    {
                        Id = "CAM-" + Guid.NewGuid().ToString().Substring(0, 5).ToUpper(),
                        Nombre = NombreCamara,
                        UrlImagen = string.IsNullOrWhiteSpace(UrlCamara) ? "http://10.10.16.93:8080/images/default.jpg" : UrlCamara,
                        Carretera = CarreteraCamara,
                        Kilometro = KmCamara,
                        Direccion = DireccionCamara,
                        Latitud = LatitudCamara,
                        Longitud = LongitudCamara
                    };
                    success = await _trafficService.AddCamaraAsync(newCam);
                }
                else
                {
                    if (string.IsNullOrWhiteSpace(TypeIncidence)) { MessageBox.Show("Tipo obligatorio"); return; }

                    var newInc = new Incidencia
                    {
                        IncidenceId = "0",
                        IncidenceType = TypeIncidence,
                        IncidenceLevel = IncidenceLevel,
                        Road = RoadIncidence,
                        CityTown = CityIncidence,
                        Province = ProvinceIncidence,
                        Cause = DescriptionIncidence,
                        Direction = DirectionIncidence,
                        Latitude = ParseCoordinate(LatitudInc),
                        Longitude = ParseCoordinate(LongitudInc),
                        StartDate = DateTime.Now
                    };
                    success = await _trafficService.AddIncidenciaAsync(newInc);
                }

                if (success) { await Task.Delay(500); Close(); }
                else { MessageBox.Show("Error al guardar en el servidor."); }
            }
            catch (Exception ex) { MessageBox.Show($"Error: {ex.Message}"); }
            finally { IsBusy = false; }
        }

        private bool CanSubmit() => !IsBusy;
    }

    // --- CONVERTIDOR AÑADIDO AQUÍ PARA EVITAR ERRORES ---
    public class InverseBoolConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is bool booleanValue) return !booleanValue;
            return value;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is bool booleanValue) return !booleanValue;
            return value;
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\AddItemViewModel.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\DashboardViewModel.cs
============================================================

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using MAVPC.Models;
using MAVPC.MVVM.Views;
using MAVPC.Services;
using System;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq; // Necesario para GroupBy en el PDF
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Data;
using System.Windows.Media;

namespace MAVPC.MVVM.ViewModels
{
    public partial class DashboardViewModel : ObservableObject
    {
        private readonly ITrafficService _trafficService;
        private readonly IPdfService _pdfService; // <--- NUEVO SERVICIO

        // --- COLECCIONES ---
        [ObservableProperty] private ObservableCollection<Camara> _cameras;
        [ObservableProperty] private ObservableCollection<Incidencia> _incidencias;

        // VISTA FILTRABLE PARA EL XAML
        public ICollectionView CamerasView { get; private set; }

        // TEXTO DE BÚSQUEDA
        private string _searchText;
        public string SearchText
        {
            get => _searchText;
            set
            {
                if (SetProperty(ref _searchText, value))
                {
                    CamerasView?.Refresh();
                }
            }
        }

        // --- KPIs Y ESTADO ---
        [ObservableProperty] private int _totalCameras;
        [ObservableProperty] private int _activeIncidents;
        [ObservableProperty] private string _systemStatus = "CONECTADO";
        [ObservableProperty] private bool _isLoading;

        // CONSTRUCTOR ACTUALIZADO: Recibe ahora AMBOS servicios
        public DashboardViewModel(ITrafficService trafficService, IPdfService pdfService)
        {
            _trafficService = trafficService;
            _pdfService = pdfService; // <--- ASIGNACIÓN

            Cameras = new ObservableCollection<Camara>();
            Incidencias = new ObservableCollection<Incidencia>();

            // Carga inicial
            LoadDataCommand.Execute(null);
        }

        [RelayCommand]
        private async Task LoadData()
        {
            if (IsLoading) return;
            IsLoading = true;
            SystemStatus = "SINCRONIZANDO...";

            try
            {
                // 1. Cargar Cámaras
                var dataCam = await _trafficService.GetCamarasAsync();
                Cameras.Clear();
                if (dataCam != null) foreach (var item in dataCam) Cameras.Add(item);

                // Inicializar la Vista Filtrable
                if (CamerasView == null)
                {
                    CamerasView = CollectionViewSource.GetDefaultView(Cameras);
                    CamerasView.Filter = FilterCameras;
                }
                else
                {
                    CamerasView.Refresh();
                }
                OnPropertyChanged(nameof(CamerasView));

                // 2. Cargar Incidencias
                var dataInc = await _trafficService.GetIncidenciasAsync();
                Incidencias.Clear();
                if (dataInc != null) foreach (var item in dataInc) Incidencias.Add(item);

                // 3. Actualizar KPIs
                TotalCameras = Cameras.Count;
                ActiveIncidents = Incidencias.Count;
                SystemStatus = "EN LÍNEA";
            }
            catch (Exception ex)
            {
                SystemStatus = "ERROR DE RED";
                MessageBox.Show($"Error al cargar datos: {ex.Message}");
            }
            finally
            {
                IsLoading = false;
            }
        }

        // LÓGICA DEL FILTRO
        private bool FilterCameras(object item)
        {
            if (item is Camara cam)
            {
                if (string.IsNullOrWhiteSpace(SearchText))
                    return true;

                string search = SearchText.ToLower();

                return (cam.Nombre != null && cam.Nombre.ToLower().Contains(search)) ||
                       (cam.Carretera != null && cam.Carretera.ToLower().Contains(search)) ||
                       (cam.Kilometro != null && cam.Kilometro.ToString().Contains(search));
            }
            return false;
        }

        [RelayCommand]
        private async Task DeleteCamera(object parameter)
        {
            if (parameter is not Camara camara) return;

            var result = MessageBox.Show(
                $"¿Estás seguro de que deseas eliminar la cámara '{camara.Nombre}'?\nEsta acción es irreversible.",
                "Confirmar Eliminación",
                MessageBoxButton.YesNo,
                MessageBoxImage.Warning);

            if (result != MessageBoxResult.Yes) return;

            try
            {
                bool exito = await _trafficService.DeleteCamaraAsync(camara.Id);

                if (exito)
                {
                    Cameras.Remove(camara);
                    TotalCameras = Cameras.Count;
                    CamerasView?.Refresh();
                }
                else
                {
                    MessageBox.Show("No se pudo eliminar la cámara. Verifica la API.", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error crítico al eliminar: {ex.Message}", "Excepción", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        [RelayCommand]
        private async Task OpenAddForm()
        {
            var window = new Window
            {
                Title = "Añadir Nuevo Punto",
                SizeToContent = SizeToContent.WidthAndHeight,
                ResizeMode = ResizeMode.NoResize,
                WindowStyle = WindowStyle.None,
                AllowsTransparency = true,
                Background = Brushes.Transparent,
                WindowStartupLocation = WindowStartupLocation.CenterScreen
            };

            Action closeAction = () => window.Close();

            // Pasamos el trafficService
            var addItemVm = new AddItemViewModel(_trafficService, closeAction);
            var view = new AddItemView { DataContext = addItemVm };

            window.Content = view;
            window.ShowDialog();

            await LoadData();
        }

        // --- EXPORTAR PDF IMPLEMENTADO ---
        [RelayCommand]
        private async Task ExportPdf()
        {
            try
            {
                var dialog = new Microsoft.Win32.SaveFileDialog
                {
                    Filter = "PDF Files (*.pdf)|*.pdf",
                    FileName = $"Informe_Ejecutivo_{DateTime.Now:yyyyMMdd_HHmm}.pdf"
                };

                if (dialog.ShowDialog() == true)
                {
                    // 1. AVISAR AL USUARIO (Porque descargar el histórico puede tardar un segundo)
                    SystemStatus = "GENERANDO PDF...";

                    // 2. DESCARGAR DATOS HISTÓRICOS (Aquí llamamos al NUEVO endpoint)
                    var historialCompleto = await _trafficService.GetAllIncidenciasAsync();

                    if (historialCompleto == null || historialCompleto.Count == 0)
                    {
                        MessageBox.Show("No se pudo descargar el historial para el reporte.", "Error");
                        SystemStatus = "EN LÍNEA";
                        return;
                    }

                    // 3. GENERAR EL REPORTE CON EL HISTORIAL
                    // (El PdfService "Pro" que hicimos antes procesará todos estos datos)
                    await Task.Run(() => _pdfService.GenerateFullReport(dialog.FileName, historialCompleto));

                    SystemStatus = "EN LÍNEA";

                    // 4. ABRIR
                    System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo
                    {
                        FileName = dialog.FileName,
                        UseShellExecute = true
                    });
                }
            }
            catch (Exception ex)
            {
                SystemStatus = "ERROR";
                MessageBox.Show($"Error generando PDF: {ex.Message}");
            }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\DashboardViewModel.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\LoginViewModel.cs
============================================================

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using CommunityToolkit.Mvvm.Messaging;
using CommunityToolkit.Mvvm.Messaging.Messages;
using MAVPC.Services;
using System.Windows.Controls;

namespace MAVPC.MVVM.ViewModels
{
    public class LoginSuccessMessage : ValueChangedMessage<string>
    {
        public LoginSuccessMessage(string user) : base(user) { }
    }

    public partial class LoginViewModel : ObservableObject
    {
        private readonly IAuthService _authService;

        [ObservableProperty] private string _username = string.Empty;
        [ObservableProperty] private string _errorMessage = string.Empty;
        [ObservableProperty] private bool _hasError;

        public LoginViewModel(IAuthService authService)
        {
            _authService = authService;
        }

        // CAMBIO: Quitamos 'async Task' y lo dejamos en 'void'
        // porque el login local es instantáneo.
        [RelayCommand]
        private void Login(object parameter)
        {
            var passwordBox = parameter as PasswordBox;
            var password = passwordBox?.Password;

            // Limpiar errores previos
            HasError = false;
            ErrorMessage = string.Empty;

            // Llamada síncrona directa (sin await)
            if (_authService.Login(Username, password))
            {
                WeakReferenceMessenger.Default.Send(new LoginSuccessMessage(Username));
            }
            else
            {
                ErrorMessage = "Credenciales incorrectas (Prueba admin/admin)";
                HasError = true;
            }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\LoginViewModel.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\MainViewModel.cs
============================================================

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using CommunityToolkit.Mvvm.Messaging;
using Microsoft.Extensions.DependencyInjection;
using System;
using System.Windows;

namespace MAVPC.MVVM.ViewModels
{
    public partial class MainViewModel : ObservableObject, IRecipient<LoginSuccessMessage>
    {
        private readonly IServiceProvider _provider;

        [ObservableProperty] private object? _currentView;
        [ObservableProperty] private bool _isLoggedIn;

        public MainViewModel(IServiceProvider provider)
        {
            _provider = provider;
            WeakReferenceMessenger.Default.Register(this);
            // Iniciamos en Login
            CurrentView = _provider.GetRequiredService<LoginViewModel>();
            IsLoggedIn = false;
        }

        public void Receive(LoginSuccessMessage message)
        {
            IsLoggedIn = true;
            // Al hacer login, vamos al Dashboard
            CurrentView = _provider.GetRequiredService<DashboardViewModel>();
        }

        // --- COMANDOS DE NAVEGACIÓN ---

        [RelayCommand]
        private void ShowDashboard()
        {
            CurrentView = _provider.GetRequiredService<DashboardViewModel>();
        }

        [RelayCommand]
        private void ShowMap()
        {
            CurrentView = _provider.GetRequiredService<MapViewModel>();
        }

        [RelayCommand]
        private void ShowStats()
        {
            CurrentView = _provider.GetRequiredService<StatsViewModel>();
        }

        // NUEVO: Comando para mostrar Usuarios
        [RelayCommand]
        private void ShowUsers()
        {
            CurrentView = _provider.GetRequiredService<UsersViewModel>();
        }

        // ------------------------------

        [RelayCommand]
        private void Logout()
        {
            IsLoggedIn = false;
            CurrentView = _provider.GetRequiredService<LoginViewModel>();
        }

        [RelayCommand] private void CloseApp() => Application.Current.Shutdown(0);
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\MainViewModel.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\MapViewModel.cs
============================================================

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using MAVPC.Models;
using MAVPC.Services;
using MAVPC.Utils;
using System;
using System.Collections.ObjectModel;
using System.Globalization;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows;

namespace MAVPC.MVVM.ViewModels
{
    public partial class MapViewModel : ObservableObject
    {
        private readonly ITrafficService _trafficService;

        private ObservableCollection<MapMarkerModel> _markers;
        public ObservableCollection<MapMarkerModel> Markers
        {
            get => _markers;
            set => SetProperty(ref _markers, value);
        }

        public MapViewModel(ITrafficService trafficService)
        {
            _trafficService = trafficService;
            _markers = new ObservableCollection<MapMarkerModel>();
            _ = CargarDatosReales();
        }

        public async Task CargarDatosReales()
        {
            var listaTemp = new ObservableCollection<MapMarkerModel>();

            // --- BLOQUE 1: INCIDENCIAS (API NUEVA - Double) ---
            try
            {
                var incidencias = await _trafficService.GetIncidenciasAsync();
                if (incidencias != null)
                {
                    foreach (var item in incidencias)
                    {
                        if (item.Latitude == null || item.Longitude == null) continue;
                        if (item.Latitude == 0 && item.Longitude == 0) continue;

                        double lat = item.Latitude.Value;
                        double lon = item.Longitude.Value;

                        // Conversión UTM si es necesario (coordenadas grandes)
                        if (Math.Abs(lat) > 90 || Math.Abs(lon) > 180)
                        {
                            var (cLat, cLon) = GpsUtils.UtmToLatLng(Math.Min(lat, lon), Math.Max(lat, lon), 30);
                            lat = cLat;
                            lon = cLon;
                        }

                        listaTemp.Add(new MapMarkerModel
                        {
                            Lat = lat,
                            Lon = lon,
                            Type = DetectarTipo(item.IncidenceType, item.Cause),
                            Title = item.IncidenceType ?? "Incidencia",
                            Description = $"{item.Cause} - {item.CityTown}",
                            DataObject = item
                        });
                    }
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error Incidencias: {ex.Message}");
            }

            // --- BLOQUE 2: CÁMARAS (API VIEJA - String) ---
            try
            {
                var camaras = await _trafficService.GetCamarasAsync();
                if (camaras != null)
                {
                    foreach (var cam in camaras)
                    {
                        // Parseo manual de strings con coma o punto
                        string sLat = cam.Latitud?.Replace(",", ".") ?? "0";
                        string sLon = cam.Longitud?.Replace(",", ".") ?? "0";

                        if (double.TryParse(sLat, NumberStyles.Any, CultureInfo.InvariantCulture, out double lat) &&
                            double.TryParse(sLon, NumberStyles.Any, CultureInfo.InvariantCulture, out double lon))
                        {
                            if (lat == 0 && lon == 0) continue;

                            if (Math.Abs(lat) > 90 || Math.Abs(lon) > 180)
                            {
                                var (cLat, cLon) = GpsUtils.UtmToLatLng(Math.Min(lat, lon), Math.Max(lat, lon), 30);
                                lat = cLat;
                                lon = cLon;
                            }

                            listaTemp.Add(new MapMarkerModel
                            {
                                Lat = lat,
                                Lon = lon,
                                Type = "camara",
                                Title = cam.Nombre ?? "Cámara",
                                Description = cam.Carretera ?? "",
                                DataObject = cam
                            });
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error Cámaras: {ex.Message}");
            }

            // --- ACTUALIZACIÓN FINAL EN UI ---
            Application.Current.Dispatcher.Invoke(() =>
            {
                Markers = listaTemp;
            });
        }

        [RelayCommand]
        public void MarkerClicked(MapMarkerModel item)
        {
            if (item?.DataObject == null) return;

            try
            {
                // Reconstruir objeto desde el JsonElement o string que devuelve el DataObject genérico
                var jsonString = item.DataObject.ToString();
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };

                if (item.Type == "camara")
                {
                    var cam = JsonSerializer.Deserialize<Camara>(jsonString, options);
                    if (cam != null) new CameraWindow(cam).Show();
                }
                else
                {
                    var inc = JsonSerializer.Deserialize<Incidencia>(jsonString, options);
                    if (inc != null) new IncidentWindow(inc).Show();
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error abriendo ventana: {ex.Message}");
            }
        }

        private string DetectarTipo(string? tipo, string? causa)
        {
            string t = (tipo ?? "").ToLower();
            string c = (causa ?? "").ToLower();
            if (t.Contains("obra") || c.Contains("obra")) return "obra";
            if (t.Contains("nieve") || c.Contains("nieve")) return "nieve";
            return "incidencia";
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\MapViewModel.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\StatsViewModel.cs
============================================================

using CommunityToolkit.Mvvm.ComponentModel;
using LiveCharts;
using LiveCharts.Wpf;
using MAVPC.Services;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace MAVPC.MVVM.ViewModels
{
    public partial class StatsViewModel : ObservableObject
    {
        private readonly ITrafficService _trafficService;

        // Propiedades de Datos
        [ObservableProperty] private SeriesCollection _incidenciasSeries;
        [ObservableProperty] private SeriesCollection _camarasSeries;
        [ObservableProperty] private SeriesCollection _carreterasSeries;

        [ObservableProperty] private string[] _labels;
        [ObservableProperty] private string[] _carreterasLabels;

        [ObservableProperty] private Func<double, string> _formatter;

        public StatsViewModel(ITrafficService trafficService)
        {
            _trafficService = trafficService;

            // Inicializar para evitar nulos
            IncidenciasSeries = new SeriesCollection();
            CamarasSeries = new SeriesCollection();
            CarreterasSeries = new SeriesCollection();

            // Formateador: Convierte 10.0 en "10"
            Formatter = value => value.ToString("N0");

            // Cargamos los datos (async void es aceptable en constructor/eventos de UI)
            LoadStats();
        }

        private async void LoadStats()
        {
            try
            {
                var incidencias = await _trafficService.GetIncidenciasAsync();
                var camaras = await _trafficService.GetCamarasAsync();

                if (incidencias == null || camaras == null) return;

                // ==========================================
                // 1. GRÁFICO CIRCULAR (Por Tipo de Incidencia)
                // ==========================================
                // CAMBIO: Usamos 'IncidenceType' en lugar de 'Tipo'
                var incidenciasPorTipo = incidencias
                    .GroupBy(x => x.IncidenceType ?? "OTROS") // Agrupamos, si es null ponemos OTROS
                    .Select(g => new { Tipo = g.Key, Cantidad = g.Count() });

                var pieSeries = new SeriesCollection();
                foreach (var item in incidenciasPorTipo)
                {
                    pieSeries.Add(new PieSeries
                    {
                        Title = item.Tipo,
                        Values = new ChartValues<int> { item.Cantidad },
                        DataLabels = true,
                        LabelPoint = chartPoint => string.Format("{0} ({1:P})", chartPoint.SeriesView.Title, chartPoint.Participation)
                    });
                }
                IncidenciasSeries = pieSeries;

                // ==========================================
                // 2. GRÁFICO COLUMNAS (Totales)
                // ==========================================
                CamarasSeries = new SeriesCollection
                {
                    new ColumnSeries
                    {
                        Title = "Total",
                        Values = new ChartValues<int> { camaras.Count, incidencias.Count },
                        Fill = System.Windows.Media.Brushes.OrangeRed
                    }
                };
                Labels = new[] { "Cámaras", "Incidencias" };

                // ==========================================
                // 3. GRÁFICO BARRAS HORIZONTALES (Top 5 Carreteras)
                // ==========================================
                // CAMBIO: Usamos 'Road' en lugar de 'Carretera'
                var topRoads = incidencias
                    .Where(x => !string.IsNullOrEmpty(x.Road)) // Filtramos nulos
                    .GroupBy(x => x.Road)
                    .OrderByDescending(g => g.Count())
                    .Take(5)
                    .Select(g => new { Carretera = g.Key, Cantidad = g.Count() })
                    .ToList();

                CarreterasSeries = new SeriesCollection
                {
                    new RowSeries
                    {
                        Title = "Incidencias",
                        Values = new ChartValues<int>(topRoads.Select(x => x.Cantidad)),
                        Fill = System.Windows.Media.Brushes.DodgerBlue
                    }
                };

                // Asignamos las etiquetas (eje Y) con los nombres de las carreteras
                CarreterasLabels = topRoads.Select(x => x.Carretera).ToArray();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error cargando estadísticas: {ex.Message}");
            }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\StatsViewModel.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\UsersViewModel.cs
============================================================

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using MAVPC.Services;
using MAVPC.Models;
using System.Collections.ObjectModel;
using System.Security.Cryptography;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Diagnostics;
using System.ComponentModel; // NECESARIO PARA EL FILTRO
using System.Windows.Data;   // NECESARIO PARA EL FILTRO

namespace MAVPC.MVVM.ViewModels
{
    public partial class UsersViewModel : ObservableObject
    {
        private readonly IAuthService _authService;

        // Variable para controlar la vista filtrada (NO es una propiedad observable)
        private ICollectionView _usersCollectionView;

        [ObservableProperty] private ObservableCollection<Usuario> _usuarios;
        [ObservableProperty] private Usuario? _selectedUsuario;

        // DIÁLOGO
        [ObservableProperty] private bool _isDialogOpen;
        [ObservableProperty] private string _dialogTitle;

        // FORMULARIO
        [ObservableProperty] private string _formUsername;
        [ObservableProperty] private string _formEmail;
        [ObservableProperty] private string _formUrlImage; // Añadido por si acaso lo usas luego

        private bool _isEditMode;

        // --- PROPIEDAD DEL BUSCADOR ---
        private string _searchText;
        public string SearchText
        {
            get => _searchText;
            set
            {
                // Al cambiar el texto, notificamos y refrescamos el filtro
                if (SetProperty(ref _searchText, value))
                {
                    _usersCollectionView?.Refresh();
                }
            }
        }

        public UsersViewModel(IAuthService authService)
        {
            _authService = authService;
            Usuarios = new ObservableCollection<Usuario>();

            // Lanzamos la carga inicial
            LoadUsers();
        }

        // Método para cargar desde la API
        private async void LoadUsers()
        {
            try
            {
                var listaApi = await _authService.GetUsuariosAsync();

                Usuarios.Clear();
                foreach (var user in listaApi)
                {
                    Usuarios.Add(user);
                }

                // --- CONFIGURACIÓN DEL FILTRO ---
                // Obtenemos la vista por defecto de la colección
                _usersCollectionView = CollectionViewSource.GetDefaultView(Usuarios);

                // Definimos la lógica: ¿Qué filas se muestran?
                _usersCollectionView.Filter = (obj) =>
                {
                    // 1. Si el buscador está vacío, mostramos todo
                    if (string.IsNullOrEmpty(SearchText)) return true;

                    // 2. Si el objeto es un usuario, comprobamos el texto
                    if (obj is Usuario user)
                    {
                        string search = SearchText.ToLower();
                        // Buscamos coincidencia en Nombre o Email
                        return (user.NombreUsuario != null && user.NombreUsuario.ToLower().Contains(search)) ||
                               (user.Email != null && user.Email.ToLower().Contains(search));
                    }
                    return false;
                };
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Error al cargar: {ex.Message}");
            }
        }

        // --- MÉTODO DE HASHEO ---
        private string HashPassword(string rawPassword)
        {
            using (SHA256 sha256 = SHA256.Create())
            {
                byte[] bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(rawPassword));
                StringBuilder builder = new StringBuilder();
                for (int i = 0; i < bytes.Length; i++)
                {
                    builder.Append(bytes[i].ToString("x2"));
                }
                return builder.ToString();
            }
        }

        [RelayCommand]
        private void OpenCreateDialog()
        {
            FormUsername = "";
            FormEmail = "";
            FormUrlImage = ""; // Limpiamos
            _isEditMode = false;
            DialogTitle = "NUEVO USUARIO";
            IsDialogOpen = true;
        }

        [RelayCommand]
        private void OpenEditDialog(Usuario? usuarioToEdit)
        {
            if (usuarioToEdit == null) return;

            SelectedUsuario = usuarioToEdit;
            FormUsername = usuarioToEdit.NombreUsuario;
            FormEmail = usuarioToEdit.Email;
            FormUrlImage = usuarioToEdit.UrlImage; // Cargamos

            _isEditMode = true;
            DialogTitle = $"EDITAR: {usuarioToEdit.NombreUsuario.ToUpper()}";
            IsDialogOpen = true;
        }

        [RelayCommand]
        private async Task DeleteUser(Usuario? usuarioToDelete)
        {
            if (usuarioToDelete == null) return;

            var result = MessageBox.Show($"¿Eliminar a {usuarioToDelete.NombreUsuario}?", "Confirmar", MessageBoxButton.YesNo, MessageBoxImage.Warning);

            if (result == MessageBoxResult.Yes)
            {
                bool exito = await _authService.EliminarUsuarioAsync(usuarioToDelete.Id);

                if (exito)
                {
                    Usuarios.Remove(usuarioToDelete);
                }
                else
                {
                    MessageBox.Show("No se pudo eliminar el usuario (API Error).", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        [RelayCommand]
        private async Task Save(object parameter)
        {
            var passwordBox = parameter as PasswordBox;
            var rawPassword = passwordBox?.Password ?? "";

            if (string.IsNullOrWhiteSpace(FormUsername) || string.IsNullOrWhiteSpace(FormEmail))
            {
                MessageBox.Show("El nombre y el email son obligatorios.", "Faltan datos", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            try
            {
                if (_isEditMode && SelectedUsuario != null)
                {
                    // === EDICIÓN ===
                    string? passwordToSend = null;

                    if (!string.IsNullOrWhiteSpace(rawPassword))
                    {
                        passwordToSend = HashPassword(rawPassword);
                    }

                    var usuarioActualizado = new Usuario
                    {
                        Id = SelectedUsuario.Id,
                        NombreUsuario = FormUsername,
                        Email = FormEmail,
                        UrlImage = FormUrlImage ?? SelectedUsuario.UrlImage, // Usamos la nueva o mantenemos
                        Contrasena = passwordToSend ?? SelectedUsuario.Contrasena
                    };

                    bool exito = await _authService.EditarUsuarioAsync(usuarioActualizado);

                    if (exito)
                    {
                        var index = Usuarios.IndexOf(SelectedUsuario);
                        if (index >= 0) Usuarios[index] = usuarioActualizado;

                        MessageBox.Show("Usuario actualizado correctamente.");
                        CloseDialog();
                        if (passwordBox != null) passwordBox.Password = "";
                    }
                    else
                    {
                        MessageBox.Show("Error al actualizar en el servidor.", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                    }
                }
                else
                {
                    // === CREACIÓN ===
                    if (string.IsNullOrWhiteSpace(rawPassword))
                    {
                        MessageBox.Show("La contraseña es obligatoria para nuevos usuarios.", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                        return;
                    }

                    string hashedPassword = HashPassword(rawPassword);

                    var newUsuario = new Usuario
                    {
                        Id = 0,
                        NombreUsuario = FormUsername,
                        Email = FormEmail,
                        Contrasena = hashedPassword,
                        UrlImage = FormUrlImage ?? ""
                    };

                    bool exito = await _authService.CrearUsuarioAsync(newUsuario);

                    if (exito)
                    {
                        MessageBox.Show("Usuario creado correctamente.");
                        CloseDialog();
                        if (passwordBox != null) passwordBox.Password = "";
                        LoadUsers(); // Recargamos para obtener ID real
                    }
                    else
                    {
                        MessageBox.Show("Error al crear usuario en el servidor.", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ocurrió un error inesperado: {ex.Message}");
            }
        }

        [RelayCommand]
        private void CloseDialog()
        {
            IsDialogOpen = false;
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\ViewModels\UsersViewModel.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\AddItemView.xaml
============================================================

<UserControl x:Class="MAVPC.MVVM.Views.AddItemView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             
             xmlns:vm="clr-namespace:MAVPC.MVVM.ViewModels" 
             
             mc:Ignorable="d" 
             d:DesignHeight="750" d:DesignWidth="800">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <vm:InverseBoolConverter x:Key="InverseBoolConverter"/>

        <SolidColorBrush x:Key="NeonCyan" Color="#00FFFF"/>
        <SolidColorBrush x:Key="NeonPink" Color="#FF007F"/>

        <Style x:Key="InverseVisibility" TargetType="FrameworkElement">
            <Setter Property="Visibility" Value="Collapsed"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsCameraSelected}" Value="False">
                    <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Border Background="#121212" CornerRadius="15" BorderThickness="2" 
            BorderBrush="{Binding CurrentColor}"
            Width="700" HorizontalAlignment="Center" VerticalAlignment="Center">

        <Border.Effect>
            <DropShadowEffect Color="{Binding CurrentColor.Color}" BlurRadius="25" Opacity="0.4" ShadowDepth="0"/>
        </Border.Effect>

        <Grid Margin="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Margin="0,0,0,25">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="DatabasePlus" Foreground="{Binding CurrentColor}" Width="28" Height="28" Margin="0,0,10,0"/>
                    <TextBlock Text="NUEVO REGISTRO" FontSize="22" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                </StackPanel>

                <Button HorizontalAlignment="Right" Command="{Binding CloseCommand}" IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}"
                        Style="{StaticResource MaterialDesignIconForegroundButton}" Foreground="Gray">
                    <materialDesign:PackIcon Kind="Close" Width="28" Height="28"/>
                </Button>
            </Grid>

            <Grid Grid.Row="1" Margin="0,0,0,25">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition/>
                </Grid.ColumnDefinitions>

                <Button Command="{Binding SwitchModeCommand}" CommandParameter="Camera" Height="55" Margin="0,0,10,0" 
                        Background="Transparent" BorderBrush="{x:Null}" IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsCameraSelected}" Value="True">
                                    <Setter Property="Background" Value="#1A00FFFF"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource NeonCyan}"/>
                                    <Setter Property="BorderThickness" Value="0,0,0,4"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                    <StackPanel>
                        <materialDesign:PackIcon Kind="Cctv" HorizontalAlignment="Center" Width="24" Height="24" Foreground="{StaticResource NeonCyan}"/>
                        <TextBlock Text="CÁMARA VIAL" Foreground="White" FontSize="12" FontWeight="SemiBold" Margin="0,5,0,0"/>
                    </StackPanel>
                </Button>

                <Button Grid.Column="1" Command="{Binding SwitchModeCommand}" CommandParameter="Incidence" Height="55" Margin="10,0,0,0" 
                        Background="Transparent" BorderBrush="{x:Null}" IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsCameraSelected}" Value="False">
                                    <Setter Property="Background" Value="#1AFF007F"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource NeonPink}"/>
                                    <Setter Property="BorderThickness" Value="0,0,0,4"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                    <StackPanel>
                        <materialDesign:PackIcon Kind="AlertOctagon" HorizontalAlignment="Center" Width="24" Height="24" Foreground="{StaticResource NeonPink}"/>
                        <TextBlock Text="INCIDENCIA" Foreground="White" FontSize="12" FontWeight="SemiBold" Margin="0,5,0,0"/>
                    </StackPanel>
                </Button>
            </Grid>

            <Grid Grid.Row="2">
                <StackPanel Visibility="{Binding IsCameraSelected, Converter={StaticResource BoolToVis}}">
                    <TextBox materialDesign:HintAssist.Hint="Identificador" Text="{Binding NombreCamara}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" CaretBrush="{StaticResource NeonCyan}" Margin="0,0,0,15"/>
                    <TextBox materialDesign:HintAssist.Hint="URL Stream" Text="{Binding UrlCamara}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" CaretBrush="{StaticResource NeonCyan}" Margin="0,0,0,15"/>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <TextBox materialDesign:HintAssist.Hint="Carretera" Text="{Binding CarreteraCamara}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,15,0"/>
                        <TextBox Grid.Column="1" materialDesign:HintAssist.Hint="KM" Text="{Binding KmCamara}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White"/>
                    </Grid>
                    <TextBox materialDesign:HintAssist.Hint="Dirección" Text="{Binding DireccionCamara}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,0,15"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <TextBox materialDesign:HintAssist.Hint="Latitud" Text="{Binding LatitudCamara}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,15,0"/>
                        <TextBox Grid.Column="1" materialDesign:HintAssist.Hint="Longitud" Text="{Binding LongitudCamara}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White"/>
                    </Grid>
                </StackPanel>

                <StackPanel Style="{StaticResource InverseVisibility}">
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <ComboBox materialDesign:HintAssist.Hint="Tipo" Text="{Binding TypeIncidence}" IsEditable="True" Style="{StaticResource MaterialDesignFloatingHintComboBox}" Foreground="White" Margin="0,0,15,0">
                            <ComboBoxItem Content="Accidente"/>
                            <ComboBoxItem Content="Obras"/>
                            <ComboBoxItem Content="Retención"/>
                            <ComboBoxItem Content="Meteo"/>
                        </ComboBox>
                        <ComboBox Grid.Column="1" materialDesign:HintAssist.Hint="Gravedad" Text="{Binding IncidenceLevel}" Style="{StaticResource MaterialDesignFloatingHintComboBox}" Foreground="White">
                            <ComboBoxItem Content="Verde" Foreground="LightGreen"/>
                            <ComboBoxItem Content="Amarillo" Foreground="Yellow"/>
                            <ComboBoxItem Content="Rojo" Foreground="Red"/>
                            <ComboBoxItem Content="Negro" Foreground="Gray"/>
                        </ComboBox>
                    </Grid>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <TextBox materialDesign:HintAssist.Hint="Vía" Text="{Binding RoadIncidence}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,15,0"/>
                        <ComboBox Grid.Column="1" materialDesign:HintAssist.Hint="Sentido" Text="{Binding DirectionIncidence}" Style="{StaticResource MaterialDesignFloatingHintComboBox}" Foreground="White">
                            <ComboBoxItem Content="Ambos"/>
                            <ComboBoxItem Content="Norte"/>
                            <ComboBoxItem Content="Sur"/>
                            <ComboBoxItem Content="Este"/>
                            <ComboBoxItem Content="Oeste"/>
                        </ComboBox>
                    </Grid>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <ComboBox materialDesign:HintAssist.Hint="Ciudad" Text="{Binding CityIncidence}" IsEditable="True" ItemsSource="{Binding SugerenciasCiudades}" Style="{StaticResource MaterialDesignFloatingHintComboBox}" Foreground="White" Margin="0,0,15,0"/>
                        <ComboBox Grid.Column="1" materialDesign:HintAssist.Hint="Provincia" Text="{Binding ProvinceIncidence}" IsEditable="True" ItemsSource="{Binding SugerenciasProvincias}" Style="{StaticResource MaterialDesignFloatingHintComboBox}" Foreground="White"/>
                    </Grid>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <TextBox materialDesign:HintAssist.Hint="Latitud" Text="{Binding LatitudInc}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,15,0"/>
                        <TextBox Grid.Column="1" materialDesign:HintAssist.Hint="Longitud" Text="{Binding LongitudInc}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White"/>
                    </Grid>
                    <TextBox materialDesign:HintAssist.Hint="Descripción" Text="{Binding DescriptionIncidence}" Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Height="50" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto"/>
                </StackPanel>
            </Grid>

            <StackPanel Grid.Row="3" Margin="0,30,0,0">
                <ProgressBar IsIndeterminate="True" Height="4" Margin="0,0,0,10" 
                             Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}" 
                             Foreground="{Binding CurrentColor}" Background="Transparent"/>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>

                    <Button Command="{Binding CloseCommand}" Content="CANCELAR" IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}"
                            Style="{StaticResource MaterialDesignOutlinedButton}" Foreground="Gray" BorderBrush="Gray" Height="50" FontSize="14"/>

                    <Button Grid.Column="2" Command="{Binding SubmitCommand}" Content="GUARDAR" 
                            Height="50" FontSize="14" FontWeight="Bold"
                            Background="{Binding CurrentColor}" BorderBrush="{Binding CurrentColor}">
                        <Button.Effect>
                            <DropShadowEffect Color="{Binding CurrentColor.Color}" BlurRadius="15" ShadowDepth="0" Opacity="0.6"/>
                        </Button.Effect>
                    </Button>
                </Grid>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\AddItemView.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\AddItemView.xaml.cs
============================================================

using System.Windows.Controls;


namespace MAVPC.MVVM.Views
{
    /// <summary>
    /// Lógica de interacción para AddItemView.xaml
    /// </summary>
    public partial class AddItemView : UserControl
    {
        public AddItemView()
        {
            InitializeComponent();
        }
    }
}

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\AddItemView.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\CameraFormView.xaml
============================================================

<UserControl x:Class="MAVPC.MVVM.Views.CameraFormView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             Width="400" Height="550">

    <Border Background="#151922" BorderBrush="#00F0FF" BorderThickness="1" CornerRadius="10">
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" Margin="0,0,0,20">
                <TextBlock Text="NUEVA CÁMARA" FontSize="20" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                <TextBlock Text="Introduce los datos del dispositivo" Foreground="Gray" HorizontalAlignment="Center" Margin="0,5,0,0"/>
            </StackPanel>

            <StackPanel Grid.Row="1">
                <TextBox Text="{Binding NewCamera.Id}" materialDesign:HintAssist.Hint="ID Cámara (Ej: CAM-01)" 
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,0,15" CaretBrush="#00F0FF"/>

                <TextBox Text="{Binding NewCamera.Nombre}" materialDesign:HintAssist.Hint="Nombre (Ej: N-1 Salida)" 
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,0,15" CaretBrush="#00F0FF"/>

                <Grid Margin="0,0,0,15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0" Text="{Binding NewCamera.Carretera}" materialDesign:HintAssist.Hint="Carretera" 
                             Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" CaretBrush="#00F0FF"/>
                    <TextBox Grid.Column="2" Text="{Binding NewCamera.Kilometro}" materialDesign:HintAssist.Hint="Kilómetro" 
                             Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" CaretBrush="#00F0FF"/>
                </Grid>

                <Grid Margin="0,0,0,15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0" Text="{Binding NewCamera.Latitud}" materialDesign:HintAssist.Hint="Latitud" 
                             Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" CaretBrush="#00F0FF"/>
                    <TextBox Grid.Column="2" Text="{Binding NewCamera.Longitud}" materialDesign:HintAssist.Hint="Longitud" 
                             Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" CaretBrush="#00F0FF"/>
                </Grid>

                <TextBox Text="{Binding NewCamera.Direccion}" materialDesign:HintAssist.Hint="Dirección / Ubicación" 
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,0,15" CaretBrush="#00F0FF"/>
            </StackPanel>

            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,20,0,0">
                <Button Command="{Binding CancelCommand}" Content="CANCELAR" Background="Transparent" BorderBrush="Gray" Foreground="Gray" Margin="0,0,10,0"/>
                <Button Command="{Binding SaveCommand}" Content="GUARDAR EN BD" Background="#00F0FF" BorderBrush="{x:Null}" Foreground="Black" FontWeight="Bold"/>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\CameraFormView.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\CameraFormView.xaml.cs
============================================================

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace MAVPC.MVVM.Views
{
    /// <summary>
    /// Lógica de interacción para CameraFormView.xaml
    /// </summary>
    public partial class CameraFormView : UserControl
    {
        public CameraFormView()
        {
            InitializeComponent();
        }
    }
}

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\CameraFormView.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\CameraWindow.xaml
============================================================

<Window x:Class="MAVPC.CameraWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="VISOR DE CÁMARA" Height="600" Width="900"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        >

    <Border Background="#101010" CornerRadius="10" BorderBrush="{StaticResource NeonCyan}" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="#1F1F1F" CornerRadius="10,10,0,0" Padding="20,15" MouseDown="Border_MouseDown">
                <DockPanel>
                    <Button DockPanel.Dock="Right" Click="BtnCerrar_Click" Style="{StaticResource MaterialDesignIconForegroundButton}" Foreground="IndianRed" ToolTip="Cerrar">
                        <materialDesign:PackIcon Kind="Close" Width="25" Height="25"/>
                    </Button>

                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Cctv" Foreground="{StaticResource NeonCyan}" Width="25" Height="25" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <TextBlock x:Name="TxtTitulo" Text="CÁMARA CCTV-01" FontSize="18" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                        <Border x:Name="BadgeEstado" CornerRadius="4" Background="#2200FF00" BorderBrush="#00FF00" BorderThickness="1" Margin="15,0,0,0" Padding="8,2">
                            <TextBlock Text="EN VIVO" Foreground="#00FF00" FontSize="10" FontWeight="Bold"/>
                        </Border>
                    </StackPanel>
                </DockPanel>
            </Border>

            <Border Grid.Row="1" Margin="20" Background="Black" BorderBrush="#333" BorderThickness="1">
                <Grid>
                    <StackPanel x:Name="PnlEstado" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <materialDesign:PackIcon Kind="SignalOff" Width="60" Height="60" Foreground="#333"/>
                        <TextBlock Text="CONECTANDO STREAM..." Foreground="#444" Margin="0,15,0,0" HorizontalAlignment="Center"/>
                    </StackPanel>

                    <MediaElement x:Name="VideoPlayer"
                                  Stretch="Uniform"
                                  LoadedBehavior="Manual"
                                  UnloadedBehavior="Stop"
                                  ScrubbingEnabled="True"
                                  MediaOpened="VideoPlayer_MediaOpened"
                                  MediaEnded="VideoPlayer_MediaEnded"
                                  MediaFailed="VideoPlayer_MediaFailed"/>
                </Grid>
            </Border>

            <Grid Grid.Row="2" Margin="20,0,20,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock Text="UBICACIÓN" Foreground="Gray" FontSize="11" FontWeight="Bold"/>
                    <TextBlock x:Name="TxtUbicacion" Text="Bilbao - N637" Foreground="White" FontSize="14" Margin="0,2,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1">
                    <TextBlock Text="PUNTO KILOMÉTRICO" Foreground="Gray" FontSize="11" FontWeight="Bold"/>
                    <TextBlock x:Name="TxtPk" Text="PK 14.500" Foreground="{StaticResource NeonCyan}" FontSize="14" Margin="0,2,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="2" HorizontalAlignment="Right">
                    <TextBlock Text="COORDENADAS" Foreground="Gray" FontSize="11" FontWeight="Bold" HorizontalAlignment="Right"/>
                    <TextBlock x:Name="TxtCoordenadas" Text="LAT: 43.25 | LON: -2.98" Foreground="White" FontSize="12" Margin="0,2,0,0" FontFamily="Consolas"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</Window>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\CameraWindow.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\CameraWindow.xaml.cs
============================================================

using System;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using MAVPC.Models;

namespace MAVPC
{
    public partial class CameraWindow : Window
    {
        public CameraWindow(Camara camara)
        {
            InitializeComponent();
            CargarDatos(camara);
        }

        private void CargarDatos(Camara cam)
        {
            TxtTitulo.Text = cam.Nombre;
            TxtUbicacion.Text = $"{cam.Carretera} - {cam.Direccion}";
            TxtPk.Text = $"PK {cam.Kilometro}";
            TxtCoordenadas.Text = $"X: {cam.Latitud} | Y: {cam.Longitud}";

            // Lógica del Vídeo: Solo intentamos reproducir una vez
            if (!string.IsNullOrEmpty(cam.UrlImagen))
            {
                try
                {
                    VideoPlayer.Source = new Uri(cam.UrlImagen);
                    VideoPlayer.Play();
                }
                catch
                {
                    MarcarComoOffline("ERROR URI");
                }
            }
            else
            {
                MarcarComoOffline("SIN SEÑAL");
            }
        }

        // --- EVENTOS SIMPLIFICADOS ---

        // 1. Cuando el vídeo arranca, quitamos el cartel de "Cargando"
        private void VideoPlayer_MediaOpened(object sender, RoutedEventArgs e)
        {
            PnlEstado.Visibility = Visibility.Collapsed;
        }

        // 2. Si falla, mostramos error (Sin reintentos ni async)
        private void VideoPlayer_MediaFailed(object sender, ExceptionRoutedEventArgs e)
        {
            MarcarComoOffline("ERROR VIDEO");
        }

        // 3. Método vacío para el bucle (Opcional)
        // Lo dejo aquí pero VACÍO. Si el XAML llama a "MediaEnded", entrará aquí, 
        // no hará nada y el vídeo se parará al final sin dar error.
        private void VideoPlayer_MediaEnded(object sender, RoutedEventArgs e)
        {
            // No hacemos nada. El vídeo se para.
        }

        // Método auxiliar para mostrar estado visual de error
        private void MarcarComoOffline(string mensaje)
        {
            PnlEstado.Visibility = Visibility.Visible;
            BadgeEstado.Background = new SolidColorBrush(Color.FromArgb(30, 255, 0, 0));
            BadgeEstado.BorderBrush = Brushes.Red;

            if (BadgeEstado.Child is TextBlock tb)
            {
                tb.Text = mensaje;
                tb.Foreground = Brushes.Red;
            }

            VideoPlayer.Stop();
        }

        // --- CONTROLES DE VENTANA ---

        private void Border_MouseDown(object sender, MouseButtonEventArgs e)
        {
            if (e.ChangedButton == MouseButton.Left)
                this.DragMove();
        }

        private void BtnCerrar_Click(object sender, RoutedEventArgs e)
        {
            VideoPlayer.Stop();
            VideoPlayer.Source = null;
            this.Close();
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\CameraWindow.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\DashboardView.xaml
============================================================

<UserControl x:Class="MAVPC.MVVM.Views.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:converters="clr-namespace:MAVPC.MVVM.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="850" d:DesignWidth="1280"
             TextElement.Foreground="{DynamicResource MaterialDesignBody}"
             TextElement.FontWeight="Regular"
             TextElement.FontSize="13"
             TextOptions.TextFormattingMode="Ideal" 
             TextOptions.TextRenderingMode="Auto"
             Background="#121212"
             FontFamily="{DynamicResource MaterialDesignFont}">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:IncidentTypeToColorConverter x:Key="TypeToColor"/>
        <converters:IncidentTypeToIconConverter x:Key="TypeToIcon"/>
    </UserControl.Resources>

    <Grid Margin="30">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <DockPanel Grid.Row="0" Margin="0,0,0,30">
            <StackPanel DockPanel.Dock="Left" Margin="0,0,10,0">
                <TextBlock Text="PANEL DE GESTIÓN" FontSize="32" FontWeight="Bold" Foreground="White"/>
                <TextBlock Text="Administración de Puntos de Tráfico y Sensores" FontSize="14" Foreground="Gray"/>
            </StackPanel>

            <Border DockPanel.Dock="Right" Background="#1A202C" CornerRadius="20" Padding="15,5" 
                    VerticalAlignment="Center" BorderBrush="{StaticResource NeonCyan}" BorderThickness="1">
                <StackPanel Orientation="Horizontal">
                    <Ellipse Width="10" Height="10" Fill="#00FF00" Margin="0,0,10,0">
                        <Ellipse.Effect>
                            <DropShadowEffect Color="#00FF00" BlurRadius="10" ShadowDepth="0"/>
                        </Ellipse.Effect>
                    </Ellipse>
                    <TextBlock Text="{Binding SystemStatus}" Foreground="White" FontWeight="Bold"/>
                </StackPanel>
            </Border>
        </DockPanel>

        <Grid Grid.Row="1" Margin="0,0,0,30">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="#1E1E1E" CornerRadius="12" Padding="20" Margin="0,0,15,0">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="15" Opacity="0.4" ShadowDepth="2"/>
                </Border.Effect>
                <DockPanel>
                    <materialDesign:PackIcon Kind="Cctv" Width="50" Height="50" Foreground="{StaticResource NeonCyan}" DockPanel.Dock="Left"/>
                    <StackPanel Margin="20,0,0,0" VerticalAlignment="Center">
                        <TextBlock Text="{Binding TotalCameras}" FontSize="36" FontWeight="Bold" Foreground="White"/>
                        <TextBlock Text="Cámaras Activas" Foreground="Gray"/>
                    </StackPanel>
                </DockPanel>
            </Border>

            <Border Grid.Column="1" Background="#1E1E1E" CornerRadius="12" Padding="20" Margin="0,0,15,0">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="15" Opacity="0.4" ShadowDepth="2"/>
                </Border.Effect>
                <DockPanel>
                    <materialDesign:PackIcon Kind="AlertOctagon" Width="50" Height="50" Foreground="{StaticResource NeonPink}" DockPanel.Dock="Left"/>
                    <StackPanel Margin="20,0,0,0" VerticalAlignment="Center">
                        <TextBlock Text="{Binding ActiveIncidents}" FontSize="36" FontWeight="Bold" Foreground="White"/>
                        <TextBlock Text="Incidencias Críticas" Foreground="Gray"/>
                    </StackPanel>
                </DockPanel>
            </Border>

            <Button Grid.Column="2" Command="{Binding LoadDataCommand}" Height="Auto" 
                    Background="#1000F0FF" BorderBrush="{StaticResource NeonCyan}" Margin="0">
                <StackPanel>
                    <materialDesign:PackIcon Kind="Refresh" HorizontalAlignment="Center" Width="35" Height="35" Foreground="{StaticResource NeonCyan}"/>
                    <TextBlock Text="SINCRONIZAR DATOS" Margin="0,5,0,0" Foreground="{StaticResource NeonCyan}"/>
                </StackPanel>
            </Button>
        </Grid>

        <Grid Grid.Row="2" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0" Text="Vista General" VerticalAlignment="Center" FontSize="20" Foreground="White" FontWeight="SemiBold" Margin="0,0,20,0"/>

            <Border Grid.Column="1" Background="#1E1E1E" CornerRadius="8" 
                    MaxWidth="450" HorizontalAlignment="Left" Padding="10,5">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Magnify" Foreground="Gray" VerticalAlignment="Center" Width="20" Height="20"/>
                    <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Buscar por nombre, carretera o KM..."
                             materialDesign:TextFieldAssist.DecorationVisibility="Hidden"
                             BorderThickness="0"
                             Foreground="White"
                             CaretBrush="{StaticResource NeonCyan}"
                             Width="350"
                             Margin="10,0,0,0"
                             VerticalAlignment="Center"/>
                </StackPanel>
            </Border>

            <StackPanel Grid.Column="2" Orientation="Horizontal">
                <Button Command="{Binding OpenAddFormCommand}" Content="AÑADIR PUNTO" Margin="0,0,10,0" 
                        Background="#333" BorderBrush="#555" Foreground="White"/>

                <Button Command="{Binding ExportPdfCommand}" Background="{StaticResource NeonPink}" BorderBrush="{x:Null}">
                    <Button.Content>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="FilePdfBox" Margin="0,0,5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="PDF" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button.Content>
                </Button>
            </StackPanel>
        </Grid>

        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3.5*"/>
                <ColumnDefinition Width="1.5*"/>
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0" Margin="0,0,20,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                    <materialDesign:PackIcon Kind="ViewGrid" Foreground="{StaticResource NeonCyan}" VerticalAlignment="Center"/>
                    <TextBlock Text="RED DE CÁMARAS EN VIVO" Foreground="{StaticResource NeonCyan}" FontWeight="Bold" Margin="8,0,0,0"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Hidden" HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding CamerasView}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,0,15,15" Width="260" Height="160">

                                    <Border CornerRadius="8" ClipToBounds="True" Background="#0F0F0F" BorderBrush="#333" BorderThickness="1">
                                        <Grid>
                                            <Image Source="{Binding UrlImagen}" Stretch="UniformToFill" Opacity="1.0"/>

                                            <Border VerticalAlignment="Bottom" Height="50">
                                                <Border.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                        <GradientStop Color="Transparent" Offset="0"/>
                                                        <GradientStop Color="#E6000000" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Border.Background>
                                            </Border>

                                            <StackPanel VerticalAlignment="Bottom" Margin="12">
                                                <TextBlock Text="{Binding Nombre}" Foreground="White" FontWeight="Bold" FontSize="14" TextTrimming="CharacterEllipsis"/>
                                                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                    <materialDesign:PackIcon Kind="MapMarker" Width="12" Height="12" Foreground="#AAAAAA" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding Carretera}" Foreground="#CCCCCC" FontSize="12" Margin="4,0,0,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding Kilometro, StringFormat='KM {0}'}" Foreground="{StaticResource NeonCyan}" FontSize="12" Margin="8,0,0,0" FontWeight="Bold" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </StackPanel>

                                        </Grid>
                                    </Border>

                                    <Button Background="Transparent" 
                                            Cursor="Hand"
                                            BorderBrush="Transparent"
                                            Click="BtnVerCamara_Click"
                                            HorizontalAlignment="Stretch" 
                                            VerticalAlignment="Stretch"
                                            Padding="0">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="Button">
                                                            <Border Background="{TemplateBinding Background}">
                                                                <ContentPresenter/>
                                                            </Border>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#11FFFFFF"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>

                                    <Button Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                            Background="#CC111111" 
                                            BorderBrush="#333"
                                            Width="28" Height="28"
                                            HorizontalAlignment="Right" VerticalAlignment="Top"
                                            Margin="5"
                                            ToolTip="Eliminar Cámara"
                                            Command="{Binding DataContext.DeleteCameraCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}">
                                        <materialDesign:PackIcon Kind="TrashCan" Width="14" Height="14" Foreground="#FF5555"/>
                                    </Button>

                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>

            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                    <materialDesign:PackIcon Kind="BellRing" Foreground="{StaticResource NeonPink}" VerticalAlignment="Center"/>
                    <TextBlock Text="ÚLTIMAS ALERTAS" Foreground="{StaticResource NeonPink}" FontWeight="Bold" Margin="8,0,0,0"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Incidencias}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Margin="0,0,5,12" Background="#1A1F26" CornerRadius="6" Padding="0">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="5"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <Border Grid.Column="0" Background="{Binding IncidenceType, Converter={StaticResource TypeToColor}}" 
                                                CornerRadius="6,0,0,6"/>

                                        <materialDesign:PackIcon Grid.Column="1" Margin="12" VerticalAlignment="Center"
                                                                 Kind="{Binding IncidenceType, Converter={StaticResource TypeToIcon}}" 
                                                                 Foreground="{Binding IncidenceType, Converter={StaticResource TypeToColor}}"
                                                                 Width="22" Height="22"/>

                                        <StackPanel Grid.Column="2" VerticalAlignment="Center" Margin="0,10">
                                            <TextBlock Text="{Binding IncidenceType}" Foreground="White" FontWeight="SemiBold" FontSize="13"/>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Road}" Foreground="Gray" FontSize="11"/>
                                                <TextBlock Text="  " Foreground="Gray" FontSize="11"/>
                                                <TextBlock Text="{Binding CityTown}" Foreground="#888" FontSize="11"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <TextBlock Grid.Column="3" Text="{Binding StartDate, StringFormat=HH:mm}" 
                                                   Foreground="Gray" FontWeight="Bold" FontSize="11" Margin="10" VerticalAlignment="Top"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Grid>

        <Grid Grid.Row="0" Grid.RowSpan="4" Background="#CC000000" 
              Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}" 
                             IsIndeterminate="True" Width="60" Height="60" Value="0" Foreground="{StaticResource NeonCyan}"/>
                <TextBlock Text="Conectando..." Foreground="White" HorizontalAlignment="Center" Margin="0,15,0,0"/>
            </StackPanel>
        </Grid>

    </Grid>
</UserControl>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\DashboardView.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\DashboardView.xaml.cs
============================================================

using MAVPC.Models;
using System.Windows;
using System.Windows.Controls;

namespace MAVPC.MVVM.Views
{
    public partial class DashboardView : UserControl
    {
        public DashboardView()
        {
            InitializeComponent();
        }

        private void BtnVerCamara_Click(object sender, RoutedEventArgs e)
        {
            var boton = sender as Button;
            var camara = boton?.DataContext as Camara;

            if (camara != null)
            {
                // Creamos y mostramos la ventana estilo "popup"
                var ventana = new CameraWindow(camara);
                ventana.ShowDialog(); // ShowDialog bloquea el fondo hasta que cierras
            }
        }

        private void MediaElement_MediaEnded(object sender, RoutedEventArgs e)
        {
            // Este código hace el bucle: cuando el vídeo acaba, vuelve al inicio (0) y reproduce
            if (sender is MediaElement media)
            {
                media.Position = TimeSpan.Zero;
                media.Play();
            }
        }    
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\DashboardView.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\IncidentWindow.xaml
============================================================

<Window x:Class="MAVPC.IncidentWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:converters="clr-namespace:MAVPC.MVVM.Converters"
        mc:Ignorable="d"
        Title="DETALLE INCIDENCIA" Height="520" Width="850"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent">

    <Window.Resources>
        <converters:IncidentTypeToColorConverter x:Key="TypeToColor"/>
        <converters:IncidentTypeToIconConverter x:Key="TypeToIcon"/>
    </Window.Resources>

    <Border CornerRadius="12" BorderThickness="1" Background="#121212"
            BorderBrush="{Binding IncidenceType, Converter={StaticResource TypeToColor}}">

        <Border.Effect>
            <DropShadowEffect Color="Black" BlurRadius="20" ShadowDepth="5" Opacity="0.5"/>
        </Border.Effect>

        <Grid>
            <Border CornerRadius="12" Opacity="0.05" 
                    Background="{Binding IncidenceType, Converter={StaticResource TypeToColor}}"/>

            <Grid Margin="25">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <Border Width="60" Height="60" CornerRadius="30" Background="#252525" BorderThickness="1"
                            BorderBrush="{Binding IncidenceType, Converter={StaticResource TypeToColor}}">
                        <materialDesign:PackIcon Kind="{Binding IncidenceType, Converter={StaticResource TypeToIcon}}" 
                                                 Width="30" Height="30" 
                                                 Foreground="{Binding IncidenceType, Converter={StaticResource TypeToColor}}"
                                                 VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    </Border>

                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="20,0">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <Border Background="#333" CornerRadius="4" Padding="6,2" Margin="0,0,10,0">
                                <TextBlock Text="{Binding IncidenceId, StringFormat='ID: {0}'}" Foreground="#AAA" FontFamily="Consolas" FontSize="11" FontWeight="Bold"/>
                            </Border>
                            <TextBlock Text="{Binding IncidenceLevel, TargetNullValue='NIVEL DESCONOCIDO'}" 
                                       Foreground="{Binding IncidenceType, Converter={StaticResource TypeToColor}}" 
                                       FontSize="12" FontWeight="Bold" VerticalAlignment="Center"/>
                        </StackPanel>

                        <TextBlock Text="{Binding IncidenceType, TargetNullValue='INCIDENCIA'}" 
                                   FontSize="24" FontWeight="Bold" Foreground="White"/>
                    </StackPanel>

                    <Button Grid.Column="2" Click="BtnCerrar_Click" Style="{StaticResource MaterialDesignIconForegroundButton}" 
                            Foreground="Gray" VerticalAlignment="Top" HorizontalAlignment="Right">
                        <materialDesign:PackIcon Kind="Close" Width="30" Height="30"/>
                    </Button>
                </Grid>

                <Separator Grid.Row="1" Background="#333" Margin="0,20"/>

                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="30"/>
                        <ColumnDefinition Width="1.5*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="UBICACIÓN EXACTA" Foreground="Gray" FontSize="10" FontWeight="Bold" Margin="0,0,0,10"/>

                        <Border Background="#1E1E1E" CornerRadius="8" Padding="15">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                    <materialDesign:PackIcon Kind="MapMarker" 
                                                             Foreground="{Binding IncidenceType, Converter={StaticResource TypeToColor}}" 
                                                             VerticalAlignment="Center" Margin="0,0,10,0"/>

                                    <TextBlock Text="{Binding CityTown, TargetNullValue='Municipio Desconocido'}" Foreground="White" FontSize="16"/>
                                    <TextBlock Text="{Binding Province, StringFormat='({0})', TargetNullValue=''}" Foreground="Gray" FontSize="16" Margin="5,0,0,0"/>
                                </StackPanel>

                                <Grid Margin="0,10,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <materialDesign:PackIcon Kind="Road" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,10,0"/>

                                    <TextBlock Grid.Column="1" Text="{Binding Road, TargetNullValue='Carretera no especificada'}" 
                                               FontSize="20" FontWeight="Bold" Foreground="White" TextWrapping="Wrap"/>
                                </Grid>

                                <StackPanel Orientation="Horizontal" Margin="24,5,0,0">
                                    <materialDesign:PackIcon Kind="ArrowRightBottom" Width="15" Height="15" Foreground="Gray" Margin="0,0,5,0"/>
                                    <TextBlock Text="{Binding Direction, TargetNullValue='Sentido no especificado'}" Foreground="#AAA" FontStyle="Italic"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <TextBlock Text="DETALLE / CAUSA" Foreground="Gray" FontSize="10" FontWeight="Bold" Margin="0,20,0,10"/>
                        <Border Background="#1E1E1E" CornerRadius="8" Padding="15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <materialDesign:PackIcon Grid.Column="0" Kind="AlertCircleOutline" 
                                                         Foreground="{Binding IncidenceType, Converter={StaticResource TypeToColor}}" 
                                                         VerticalAlignment="Top" Margin="0,2,10,0"/>

                                <TextBlock Grid.Column="1" Text="{Binding Cause, TargetNullValue='Sin detalles adicionales.'}" 
                                           Foreground="#DDD" TextWrapping="Wrap" LineHeight="20"/>
                            </Grid>
                        </Border>
                    </StackPanel>

                    <StackPanel Grid.Column="2">

                        <TextBlock Text="CRONOLOGÍA" Foreground="Gray" FontSize="10" FontWeight="Bold" Margin="0,0,0,10"/>
                        <Border Background="#1E1E1E" CornerRadius="8" Padding="15" Margin="0,0,0,20">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <materialDesign:PackIcon Kind="ClockTimeFiveOutline" 
                                                         Foreground="{Binding IncidenceType, Converter={StaticResource TypeToColor}}" 
                                                         Width="25" Height="25" VerticalAlignment="Center" Margin="0,0,15,0"/>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Inicio Incidencia" Foreground="Gray" FontSize="10"/>
                                    <TextBlock Text="{Binding StartDate, StringFormat='dd MMM yyyy'}" Foreground="White" FontWeight="Bold"/>
                                    <TextBlock Text="{Binding StartDate, StringFormat='HH:mm:ss'}" Foreground="White" FontSize="16"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <TextBlock Text="COORDENADAS RAW" Foreground="Gray" FontSize="10" FontWeight="Bold" Margin="0,0,0,10"/>
                        <Border Background="#151515" CornerRadius="8" Padding="15" BorderThickness="1" BorderBrush="#333">
                            <StackPanel>
                                <Grid Margin="0,0,0,8">
                                    <TextBlock Text="LAT" Foreground="#666" FontWeight="Bold" FontSize="10"/>
                                    <TextBlock Text="{Binding Latitude, StringFormat='N6'}" FontFamily="Consolas" 
                                               Foreground="{Binding IncidenceType, Converter={StaticResource TypeToColor}}" 
                                               HorizontalAlignment="Right"/>
                                </Grid>
                                <Grid Margin="0,0,0,15">
                                    <TextBlock Text="LON" Foreground="#666" FontWeight="Bold" FontSize="10"/>
                                    <TextBlock Text="{Binding Longitude, StringFormat='N6'}" FontFamily="Consolas" 
                                               Foreground="{Binding IncidenceType, Converter={StaticResource TypeToColor}}" 
                                               HorizontalAlignment="Right"/>
                                </Grid>

                                <Button Click="BtnCopiar_Click" Style="{StaticResource MaterialDesignOutlinedButton}" 
                                        Height="25" Padding="10,0" BorderBrush="#444" Foreground="#AAA"
                                        HorizontalAlignment="Stretch" Content="COPIAR DATOS"/>
                            </StackPanel>
                        </Border>

                    </StackPanel>
                </Grid>

            </Grid>
        </Grid>
    </Border>
</Window>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\IncidentWindow.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\IncidentWindow.xaml.cs
============================================================

using MAVPC.Models;
using System.Windows;
using System.Windows.Input;

namespace MAVPC
{
    public partial class IncidentWindow : Window
    {
        private Incidencia _incidencia;

        public IncidentWindow(Incidencia inc)
        {
            InitializeComponent();
            _incidencia = inc;
            this.DataContext = _incidencia;
        }

        private void BtnCerrar_Click(object sender, RoutedEventArgs e) => this.Close();

        private void Border_MouseDown(object sender, MouseButtonEventArgs e)
        {
            if (e.ChangedButton == MouseButton.Left) this.DragMove();
        }

        private void BtnCopiar_Click(object sender, RoutedEventArgs e)
        {
            if (_incidencia.Latitude.HasValue && _incidencia.Longitude.HasValue)
            {
                string data = $"{_incidencia.Latitude.Value}, {_incidencia.Longitude.Value}";
                Clipboard.SetText(data);
                // Usamos un Snackbar o MessageBox discreto
                MessageBox.Show($"Copiado al portapapeles:\n{data}", "Coordenadas", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\IncidentWindow.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\LoginView.xaml
============================================================

<UserControl x:Class="MAVPC.MVVM.Views.LoginView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="1.5*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="#05080D">
            <Grid>
                <Path Data="M0,100 L100,0 L100,100 Z" Fill="#1000F0FF" Stretch="Uniform" VerticalAlignment="Bottom" HorizontalAlignment="Right" Width="400" Opacity="0.2"/>

                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock Text="MAVPC" 
                   FontSize="60" 
                   FontWeight="Bold" 
                   Foreground="White" 
                   VerticalAlignment="Center" 
                   Margin="0,0,15,0"/>
                        <materialDesign:PackIcon Kind="TrafficLight" 
                                 Width="100" 
                                 Height="100" 
                                 Foreground="{StaticResource NeonCyan}" 
                                 VerticalAlignment="Center"/>
                    </StackPanel>

                    <TextBlock Text="CENTRO DE CONTROL DE TRÁFICO" 
               FontSize="18" 
               Foreground="Gray" 
               HorizontalAlignment="Center" 
               Margin="0,10,0,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="#121212" Padding="60">
            <StackPanel VerticalAlignment="Center">
                <TextBlock Text="INICIAR SESIÓN" Foreground="White" FontSize="32" FontWeight="Light" Margin="0,0,0,10"/>
                <TextBlock Text="Acceso autorizado únicamente" Foreground="Gray" FontSize="14" Margin="0,0,0,50"/>

                <TextBox Text="{Binding Username}" materialDesign:HintAssist.Hint="ID DE OPERADOR"
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}" Foreground="White" Margin="0,0,0,30" FontSize="16" CaretBrush="{StaticResource NeonCyan}"/>

                <PasswordBox x:Name="UserPassword" materialDesign:HintAssist.Hint="CONTRASEÑA"
                             Style="{StaticResource MaterialDesignFloatingHintPasswordBox}" Foreground="White" Margin="0,0,0,40" FontSize="16" CaretBrush="{StaticResource NeonCyan}"/>

                <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource NeonPink}" 
                           Visibility="{Binding HasError, Converter={StaticResource BoolToVis}}" Margin="0,0,0,20"/>

                <Button Command="{Binding LoginCommand}" CommandParameter="{Binding ElementName=UserPassword}"
                        Content="ENTRAR AL SISTEMA" Height="50" Background="{StaticResource NeonCyan}" Foreground="Black" FontWeight="Bold" FontSize="16"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\LoginView.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\LoginView.xaml.cs
============================================================

using System.Windows.Controls;

namespace MAVPC.MVVM.Views
{
    public partial class LoginView : UserControl
    {
        public LoginView()
        {
            InitializeComponent();
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\LoginView.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\MainView.xaml
============================================================

<Window x:Class="MAVPC.MVVM.Views.MainView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:MAVPC.MVVM.ViewModels"
        xmlns:views="clr-namespace:MAVPC.MVVM.Views"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="MAVPC" Height="800" Width="1200"
        WindowStartupLocation="CenterScreen" 
        WindowStyle="None"
        WindowState="Maximized"
        Background="{StaticResource DarkBg}"
        AllowsTransparency="True">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <DataTemplate DataType="{x:Type vm:LoginViewModel}">
            <views:LoginView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:DashboardViewModel}">
            <views:DashboardView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:MapViewModel}">
            <views:MapView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:StatsViewModel}">
            <views:StatsView/>
        </DataTemplate>

        <DataTemplate DataType="{x:Type vm:UsersViewModel}">
            <views:UsersView/>
        </DataTemplate>
    </Window.Resources>

    <Border BorderBrush="#333" BorderThickness="1">
        <Grid>
            <Grid Opacity="0.05" IsHitTestVisible="False">
                <Grid.Background>
                    <DrawingBrush Viewport="0,0,50,50" ViewportUnits="Absolute" TileMode="Tile">
                        <DrawingBrush.Drawing>
                            <GeometryDrawing>
                                <GeometryDrawing.Pen>
                                    <Pen Brush="White" Thickness="0.1"/>
                                </GeometryDrawing.Pen>
                                <GeometryDrawing.Geometry>
                                    <RectangleGeometry Rect="0,0,50,50"/>
                                </GeometryDrawing.Geometry>
                            </GeometryDrawing>
                        </DrawingBrush.Drawing>
                    </DrawingBrush>
                </Grid.Background>
            </Grid>

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Width="260" Background="{StaticResource PanelBg}" 
                        Visibility="{Binding IsLoggedIn, Converter={StaticResource BoolToVis}}">
                    <StackPanel>
                        <StackPanel Margin="30">
                            <materialDesign:PackIcon Kind="TrafficLight" Width="40" Height="40" Foreground="{StaticResource NeonCyan}" HorizontalAlignment="Center"/>
                            <TextBlock Text="MAVPC" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Foreground="White" Margin="0,10,0,0"/>
                        </StackPanel>

                        <StackPanel Margin="10,20">

                            <RadioButton Style="{StaticResource MaterialDesignTabRadioButton}"
                                         Height="50" 
                                         Command="{Binding ShowDashboardCommand}"
                                         IsChecked="True"
                                         Foreground="White"
                                         Padding="20,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="ViewDashboard" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBlock Text="DASHBOARD" VerticalAlignment="Center"/>
                                </StackPanel>
                            </RadioButton>

                            <RadioButton Style="{StaticResource MaterialDesignTabRadioButton}"
                                         Height="50" 
                                         Command="{Binding ShowMapCommand}"
                                         Foreground="White"
                                         Padding="20,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="MapMarker" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBlock Text="MAPA" VerticalAlignment="Center"/>
                                </StackPanel>
                            </RadioButton>

                            <RadioButton Style="{StaticResource MaterialDesignTabRadioButton}" Height="50" Command="{Binding ShowStatsCommand}" Foreground="White" Padding="20,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="ChartBar" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBlock Text="ESTADÍSTICAS" VerticalAlignment="Center"/>
                                </StackPanel>
                            </RadioButton>

                            <RadioButton Style="{StaticResource MaterialDesignTabRadioButton}" Height="50" Command="{Binding ShowUsersCommand}" Foreground="White" Padding="20,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="AccountGroup" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBlock Text="USUARIOS" VerticalAlignment="Center"/>
                                </StackPanel>
                            </RadioButton>

                        </StackPanel>

                        <Button Command="{Binding LogoutCommand}" Content="CERRAR SESIÓN" Margin="20" Background="{StaticResource NeonPink}" BorderBrush="{x:Null}"/>
                    </StackPanel>
                </Border>

                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" Background="Transparent" MouseDown="TitleBar_MouseDown">
                        <Button Click="CloseButton_Click" Content="X" HorizontalAlignment="Right" Width="50" Background="Transparent" BorderBrush="{x:Null}" Foreground="Red"/>
                    </Grid>

                    <ContentControl Grid.Row="1" Content="{Binding CurrentView}"/>
                </Grid>
            </Grid>
        </Grid>
    </Border>
</Window>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\MainView.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\MainView.xaml.cs
============================================================

using System.Windows;
using System.Windows.Input;

namespace MAVPC.MVVM.Views
{
    public partial class MainView : Window
    {
        public MainView()
        {
            InitializeComponent();
        }

        private void TitleBar_MouseDown(object sender, MouseButtonEventArgs e)
        {
            if (e.LeftButton == MouseButtonState.Pressed)
                DragMove();
        }

        private void CloseButton_Click(object sender, RoutedEventArgs e)
        {
            // Opcional: Desvincula el DataContext para que LiveCharts deje de escuchar
            this.DataContext = null;

            // Mata el proceso de golpe. Al ser un evento directo, no da error de Reflexión.
            Environment.Exit(0);
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\MainView.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\MapView.xaml
============================================================

<UserControl x:Class="MAVPC.MVVM.Views.MapView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <wv2:WebView2 x:Name="MapBrowser" Source="about:blank"/>
    </Grid>
</UserControl>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\MapView.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\MapView.xaml.cs
============================================================

using System;
using System.IO;
using System.Text.Json;
using System.Windows;
using System.Windows.Controls;
using MAVPC.Models;
using MAVPC.MVVM.ViewModels;
using Microsoft.Web.WebView2.Core;

namespace MAVPC.MVVM.Views
{
    public partial class MapView : UserControl
    {
        private MapViewModel? _viewModel;
        private bool _isMapLoaded = false;

        public MapView()
        {
            InitializeComponent();
            InitializeAsync();
            this.DataContextChanged += MapView_DataContextChanged;
        }

        private async void InitializeAsync()
        {
            try
            {
                await MapBrowser.EnsureCoreWebView2Async();

                string currentDir = AppDomain.CurrentDomain.BaseDirectory;
                string mapPath = Path.Combine(currentDir, "Assets", "mapa.html");

                if (File.Exists(mapPath))
                {
                    MapBrowser.WebMessageReceived += MapBrowser_WebMessageReceived;
                    // Truco: Convertimos a URI para evitar problemas de rutas raras en Windows
                    MapBrowser.CoreWebView2.Navigate(new Uri(mapPath).AbsoluteUri);
                    MapBrowser.NavigationCompleted += MapBrowser_NavigationCompleted;
                }
                else
                {
                    MessageBox.Show($"Falta el archivo: {mapPath}");
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("Error iniciando WebView2: " + ex.Message);
            }
        }

        // Se ejecuta cuando el HTML ha terminado de cargar
        private void MapBrowser_NavigationCompleted(object? sender, CoreWebView2NavigationCompletedEventArgs e)
        {
            _isMapLoaded = true;
            RefrescarMapa(); // Si ya había datos, los pintamos ahora
        }

        private void MapView_DataContextChanged(object sender, DependencyPropertyChangedEventArgs e)
        {
            if (DataContext is MapViewModel vm)
            {
                _viewModel = vm;
                // Nos suscribimos a cambios en la lista de marcadores
                _viewModel.PropertyChanged += (s, args) =>
                {
                    if (args.PropertyName == "Markers")
                    {
                        RefrescarMapa();
                    }
                };
                // Intento inicial por si ya hay datos
                RefrescarMapa();
            }
        }

        private async void RefrescarMapa()
        {
            // Verificamos que todo esté listo para no dar errores tontos
            if (!_isMapLoaded || _viewModel == null || _viewModel.Markers == null || MapBrowser.CoreWebView2 == null) return;

            try
            {
                // 1. Serializamos a JSON
                var options = new JsonSerializerOptions { PropertyNamingPolicy = null };
                var json = JsonSerializer.Serialize(_viewModel.Markers, options);

                // --- CORRECCIÓN CRÍTICA ---
                // Escapamos las comillas simples (') porque si no rompen la cadena de JS
                // Ejemplo: "Sant'Ana" rompía la llamada CargarMarcadores('...')
                var jsonSafe = json.Replace("'", "\\'");

                // 2. Ejecutamos la función JS
                await MapBrowser.CoreWebView2.ExecuteScriptAsync($"CargarMarcadores('{jsonSafe}')");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("Error enviando datos al mapa: " + ex.Message);
            }
        }

        // Recibe el click desde el JS
        private void MapBrowser_WebMessageReceived(object? sender, CoreWebView2WebMessageReceivedEventArgs e)
        {
            try
            {
                string jsonString = e.TryGetWebMessageAsString();
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var markerClicked = JsonSerializer.Deserialize<MapMarkerModel>(jsonString, options);

                if (_viewModel != null && markerClicked != null)
                {
                    // Ejecutamos el comando en el hilo de UI
                    Application.Current.Dispatcher.Invoke(() =>
                    {
                        _viewModel.MarkerClickedCommand.Execute(markerClicked);
                    });
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error al procesar click: {ex.Message}");
            }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\MapView.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\StatsView.xaml
============================================================

<UserControl x:Class="MAVPC.MVVM.Views.StatsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             mc:Ignorable="d" d:DesignHeight="600" d:DesignWidth="900">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="300"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Text="DASHBOARD ANALÍTICO" Foreground="White" FontSize="28" FontWeight="Bold" Margin="0,0,0,20"/>

        <Grid Grid.Row="1" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="#222" CornerRadius="10" Padding="15" Margin="0,0,10,0">
                <Grid>
                    <TextBlock Text="Incidencias por Tipo" Foreground="Cyan" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Top"/>
                    <lvc:PieChart Series="{Binding IncidenciasSeries}" LegendLocation="Right" InnerRadius="30" Margin="0,30,0,0">
                        <lvc:PieChart.ChartLegend>
                            <lvc:DefaultLegend Foreground="White"/>
                        </lvc:PieChart.ChartLegend>
                    </lvc:PieChart>
                </Grid>
            </Border>

            <Border Grid.Column="1" Background="#222" CornerRadius="10" Padding="15" Margin="10,0,0,0">
                <Grid>
                    <TextBlock Text="Volumen Total" Foreground="OrangeRed" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Top"/>
                    <lvc:CartesianChart Series="{Binding CamarasSeries}" LegendLocation="None" Margin="0,30,0,0">
                        <lvc:CartesianChart.AxisX>
                            <lvc:Axis Labels="{Binding Labels}" Foreground="White">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Step="1" StrokeThickness="0"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisX>
                        <lvc:CartesianChart.AxisY>
                            <lvc:Axis Foreground="Gray" LabelFormatter="{Binding Formatter}"/>
                        </lvc:CartesianChart.AxisY>
                    </lvc:CartesianChart>
                </Grid>
            </Border>
        </Grid>

        <Border Grid.Row="2" Background="#222" CornerRadius="10" Padding="15">
            <Grid>
                <TextBlock Text="Top 5 Carreteras Conflictivas" Foreground="DodgerBlue" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Top"/>

                <lvc:CartesianChart Series="{Binding CarreterasSeries}" LegendLocation="None" Margin="0,30,0,0">
                    <lvc:CartesianChart.AxisX>
                        <lvc:Axis Foreground="Gray" LabelFormatter="{Binding Formatter}"/>
                    </lvc:CartesianChart.AxisX>
                    <lvc:CartesianChart.AxisY>
                        <lvc:Axis Labels="{Binding CarreterasLabels}" Foreground="White" FontSize="12">
                            <lvc:Axis.Separator>
                                <lvc:Separator Step="1" StrokeThickness="0"/>
                            </lvc:Axis.Separator>
                        </lvc:Axis>
                    </lvc:CartesianChart.AxisY>
                    <lvc:CartesianChart.DataTooltip>
                        <lvc:DefaultTooltip SelectionMode="SharedYValues" Background="#333" Foreground="White"/>
                    </lvc:CartesianChart.DataTooltip>
                </lvc:CartesianChart>
            </Grid>
        </Border>

    </Grid>
</UserControl>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\StatsView.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\StatsView.xaml.cs
============================================================

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace MAVPC.MVVM.Views
{
    /// <summary>
    /// Lógica de interacción para StatsView.xaml
    /// </summary>
    public partial class StatsView : UserControl
    {
        public StatsView()
        {
            InitializeComponent();
        }
    }
}

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\StatsView.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\UsersView.xaml
============================================================

<UserControl x:Class="MAVPC.MVVM.Views.UsersView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1100"
             TextElement.Foreground="White"
             Background="Transparent"
             FontFamily="{DynamicResource MaterialDesignFont}">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </UserControl.Resources>

    <Grid>
        <Grid Margin="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Margin="0,0,0,25">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                    <TextBlock Text="Usuarios del Sistema" FontSize="28" FontWeight="Bold" Foreground="White"/>
                    <TextBlock Text="Administra los accesos y roles de la plataforma" FontSize="14" Foreground="#888" Margin="0,5,0,0"/>
                </StackPanel>

                <Border Grid.Column="2" Background="#1E1E1E" CornerRadius="8" Width="250" Height="45" Margin="0,0,20,0" BorderBrush="#333" BorderThickness="1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <materialDesign:PackIcon Kind="Magnify" Foreground="#666" VerticalAlignment="Center" Margin="10,0" Width="20" Height="20"/>

                        <TextBox materialDesign:HintAssist.Hint="Buscar usuario..." 
                                 materialDesign:TextFieldAssist.DecorationVisibility="Hidden" 
                                 BorderThickness="0" 
                                 VerticalAlignment="Center" 
                                 Foreground="White" 
                                 CaretBrush="{StaticResource NeonCyan}" 
                                 Grid.Column="1" 
                                 Margin="0,0,10,0"
                                 Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"/>
                    </Grid>
                </Border>

                <Button Grid.Column="3" Command="{Binding OpenCreateDialogCommand}" Height="45" materialDesign:ButtonAssist.CornerRadius="8" Background="{StaticResource NeonCyan}" BorderBrush="{StaticResource NeonCyan}" Foreground="Black" FontWeight="Bold" Padding="20,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="AccountPlus" Width="20" Height="20" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <TextBlock Text="NUEVO USUARIO" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </Grid>

            <Border Grid.Row="1" Background="#1E1E1E" CornerRadius="15" BorderBrush="#333" BorderThickness="1">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="20" ShadowDepth="5" Opacity="0.3"/>
                </Border.Effect>

                <DataGrid ItemsSource="{Binding Usuarios}" 
                          SelectedItem="{Binding SelectedUsuario}"
                          AutoGenerateColumns="False" 
                          CanUserAddRows="False"
                          IsReadOnly="True"
                          SelectionMode="Single"
                          HeadersVisibility="Column"
                          Background="Transparent"
                          BorderThickness="0"
                          RowHeight="60"
                          GridLinesVisibility="Horizontal"
                          HorizontalGridLinesBrush="#2A2A2A"
                          Padding="10">

                    <DataGrid.Resources>
                        <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDesignDataGridCell}">
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="DataGridCell">
                                        <Border BorderThickness="0" Background="{TemplateBinding Background}" SnapsToDevicePixels="True">
                                            <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="Foreground" Value="White"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>

                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="#888"/>
                            <Setter Property="FontWeight" Value="SemiBold"/>
                            <Setter Property="FontSize" Value="13"/>
                            <Setter Property="Height" Value="50"/>
                            <Setter Property="Padding" Value="20,0"/>
                            <Setter Property="HorizontalContentAlignment" Value="Left"/>
                            <Setter Property="BorderThickness" Value="0,0,0,1"/>
                            <Setter Property="BorderBrush" Value="#333"/>
                        </Style>

                        <Style TargetType="DataGridRow" BasedOn="{StaticResource MaterialDesignDataGridRow}">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#252525"/>
                                </Trigger>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#383838"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource NeonCyan}"/>
                                    <Setter Property="BorderThickness" Value="1"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Resources>

                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="#" Width="60">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Id}" Foreground="#666" VerticalAlignment="Center" Margin="20,0"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTemplateColumn Header="USUARIO" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="20,0">
                                        <Border Width="40" Height="40" CornerRadius="20" Background="#2D2D2D" BorderBrush="#444" BorderThickness="1" Margin="0,0,15,0">
                                            <materialDesign:PackIcon Kind="User" Foreground="#555" Width="20" Height="20" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <TextBlock Text="{Binding NombreUsuario}" Foreground="White" FontSize="15" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTemplateColumn Header="EMAIL" Width="3*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Email}" Foreground="#BBB" VerticalAlignment="Center" Margin="20,0"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTemplateColumn Header="ACCIONES" Width="140">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,20,0">
                                        <Button Style="{StaticResource MaterialDesignOutlinedButton}" Width="35" Height="35" Padding="0" BorderBrush="#444" Foreground="{StaticResource NeonCyan}" ToolTip="Editar Usuario" Command="{Binding DataContext.OpenEditDialogCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}" Margin="0,0,10,0">
                                            <materialDesign:PackIcon Kind="PencilOutline" Width="18" Height="18"/>
                                        </Button>
                                        <Button Style="{StaticResource MaterialDesignOutlinedButton}" Width="35" Height="35" Padding="0" BorderBrush="#444" Foreground="#FF5252" ToolTip="Eliminar Usuario" Command="{Binding DataContext.DeleteUserCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}">
                                            <materialDesign:PackIcon Kind="TrashCanOutline" Width="18" Height="18"/>
                                        </Button>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Border>
        </Grid>

        <Grid Visibility="{Binding IsDialogOpen, Converter={StaticResource BoolToVis}}" Background="#CC000000">
            <Border Background="#1E1E1E" Width="450" VerticalAlignment="Center" HorizontalAlignment="Center" CornerRadius="16" BorderBrush="#333" BorderThickness="1">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="50" ShadowDepth="10" Opacity="0.8"/>
                </Border.Effect>
                <StackPanel Margin="40">
                    <Border Width="60" Height="60" CornerRadius="30" Background="#252525" HorizontalAlignment="Center" Margin="0,0,0,20">
                        <materialDesign:PackIcon Kind="AccountDetails" Width="30" Height="30" Foreground="{StaticResource NeonCyan}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    </Border>
                    <TextBlock Text="{Binding DialogTitle}" FontSize="20" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" Margin="0,0,0,30"/>

                    <TextBox Style="{StaticResource MaterialDesignOutlinedTextBox}" materialDesign:HintAssist.Hint="Nombre de Usuario" materialDesign:HintAssist.Foreground="{StaticResource NeonCyan}" Text="{Binding FormUsername, UpdateSourceTrigger=PropertyChanged}" Foreground="White" BorderBrush="#444" Margin="0,0,0,20"/>
                    <TextBox Style="{StaticResource MaterialDesignOutlinedTextBox}" materialDesign:HintAssist.Hint="Correo Electrónico" materialDesign:HintAssist.Foreground="{StaticResource NeonCyan}" Text="{Binding FormEmail, UpdateSourceTrigger=PropertyChanged}" Foreground="White" BorderBrush="#444" Margin="0,0,0,20"/>

                    <TextBox Style="{StaticResource MaterialDesignOutlinedTextBox}" materialDesign:HintAssist.Hint="URL Imagen (Opcional)" materialDesign:HintAssist.Foreground="{StaticResource NeonCyan}" Text="{Binding FormUrlImage, UpdateSourceTrigger=PropertyChanged}" Foreground="White" BorderBrush="#444" Margin="0,0,0,20"/>

                    <PasswordBox x:Name="DialogPasswordBox" Style="{StaticResource MaterialDesignOutlinedPasswordBox}" materialDesign:HintAssist.Hint="Contraseña (vacío para no cambiar)" materialDesign:HintAssist.Foreground="{StaticResource NeonCyan}" Foreground="White" BorderBrush="#444" Margin="0,0,0,35"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Button Grid.Column="0" Content="CANCELAR" Command="{Binding CloseDialogCommand}" Style="{StaticResource MaterialDesignFlatButton}" Foreground="#888" Margin="0,0,10,0"/>
                        <Button Grid.Column="1" Content="GUARDAR" Command="{Binding SaveCommand}" CommandParameter="{Binding ElementName=DialogPasswordBox}" Background="{StaticResource NeonCyan}" BorderBrush="{StaticResource NeonCyan}" Foreground="Black" FontWeight="Bold" materialDesign:ButtonAssist.CornerRadius="6" Margin="10,0,0,0"/>
                    </Grid>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\UsersView.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\UsersView.xaml.cs
============================================================

using System.Windows.Controls;
using System.Windows.Input;
using MAVPC.MVVM.ViewModels; // Asegúrate de tener este using

namespace MAVPC.MVVM.Views
{
    public partial class UsersView : UserControl
    {
        public UsersView()
        {
            InitializeComponent();
        }

        // Si hacen click en el fondo oscuro (Overlay)
        private void Overlay_MouseDown(object sender, MouseButtonEventArgs e)
        {
            if (DataContext is UsersViewModel vm)
            {
                vm.CloseDialogCommand.Execute(null);
            }
        }

        // Si hacen click dentro de la tarjeta, DETENEMOS el evento para que no llegue al fondo
        private void Card_MouseDown(object sender, MouseButtonEventArgs e)
        {
            e.Handled = true;
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MVVM\Views\UsersView.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\AuthService.cs
============================================================

using MAVPC.Models;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

namespace MAVPC.Services
{
    public class AuthService : IAuthService
    {
        private readonly HttpClient _httpClient;
        private const string BaseUrl = "https://mavpc.up.railway.app/api/";

        public AuthService()
        {
            _httpClient = new HttpClient();
            // Timeout por si la API va lenta al gestionar usuarios
            _httpClient.Timeout = TimeSpan.FromSeconds(10);
        }

        // --- 1. LOGIN LOCAL (Escritorio) ---
        public bool Login(string username, string password)
        {
            // Aquí solo entra el administrador del sistema
            // Puedes cambiar esto por lo que quieras o dejarlo así
            return username == "admin" && password == "admin";
        }

        // --- 2. GESTIÓN DE USUARIOS (CRUD hacia la API) ---

        public async Task<List<Usuario>> GetUsuariosAsync()
        {
            try
            {
                var response = await _httpClient.GetAsync(BaseUrl + "usuarios");
                if (response.IsSuccessStatusCode)
                {
                    var json = await response.Content.ReadAsStringAsync();
                    var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    return JsonSerializer.Deserialize<List<Usuario>>(json, options) ?? new List<Usuario>();
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Error obteniendo usuarios: {ex.Message}");
            }
            return new List<Usuario>();
        }

        public async Task<bool> CrearUsuarioAsync(Usuario usuario)
        {
            try
            {
                var json = JsonSerializer.Serialize(usuario);
                var content = new StringContent(json, Encoding.UTF8, "application/json");

                // POST a /usuarios
                var response = await _httpClient.PostAsync(BaseUrl + "usuarios", content);
                return response.IsSuccessStatusCode;
            }
            catch { return false; }
        }

        public async Task<bool> EditarUsuarioAsync(Usuario usuario)
        {
            try
            {
                var json = JsonSerializer.Serialize(usuario);
                var content = new StringContent(json, Encoding.UTF8, "application/json");

                // PUT a /usuarios
                var response = await _httpClient.PutAsync(BaseUrl + "usuarios", content);
                return response.IsSuccessStatusCode;
            }
            catch { return false; }
        }

        public async Task<bool> EliminarUsuarioAsync(int id)
        {
            try
            {
                // DELETE a /usuarios?idUsuario=X
                string url = $"{BaseUrl}usuarios?idUsuario={id}";
                var response = await _httpClient.DeleteAsync(url);
                return response.IsSuccessStatusCode;
            }
            catch { return false; }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\AuthService.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\IAuthService.cs
============================================================

using MAVPC.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace MAVPC.Services
{
    public interface IAuthService
    {
        // Login LOCAL (Solo comprueba si eres el admin de la app de escritorio)
        bool Login(string username, string password);

        // GESTIÓN DE USUARIOS DE LA API (CRUD para la app móvil)
        Task<List<Usuario>> GetUsuariosAsync();
        Task<bool> CrearUsuarioAsync(Usuario usuario);
        Task<bool> EditarUsuarioAsync(Usuario usuario);
        Task<bool> EliminarUsuarioAsync(int id);
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\IAuthService.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\IPdfService.cs
============================================================

using MAVPC.Models;
using System.Collections.Generic;

namespace MAVPC.Services
{
    public interface IPdfService
    {
        void GenerateFullReport(string filePath, List<Incidencia> incidencias);
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\IPdfService.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\ITrafficService.cs
============================================================

using MAVPC.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace MAVPC.Services
{
    public interface ITrafficService
    {
        // Métodos de Lectura (GET)
        Task<List<Camara>> GetCamarasAsync();

        // El actual (solo activas)
        Task<List<Incidencia>> GetIncidenciasAsync();

        // --- NUEVO: El que trae todo el historial (api/incidencias) ---
        Task<List<Incidencia>> GetAllIncidenciasAsync();

        // Métodos de Escritura (POST/DELETE)
        Task<bool> AddCamaraAsync(Camara nuevaCamara);
        Task<bool> AddIncidenciaAsync(Incidencia nuevaIncidencia);
        Task<bool> DeleteCamaraAsync(string id);
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\ITrafficService.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\PdfService.cs
============================================================

using QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;
using ScottPlot;
using SkiaSharp;
using MAVPC.Models;
using System.Collections.Generic;
using System.Linq;
using System;

// ALIAS ESTRICTOS
using QColors = QuestPDF.Helpers.Colors;
using QFonts = QuestPDF.Helpers.Fonts;
using SColors = ScottPlot.Colors;
using SImageFormat = ScottPlot.ImageFormat;
using SColor = ScottPlot.Color;

namespace MAVPC.Services
{
    public class PdfService : IPdfService
    {
        // Paleta Corporativa
        private static readonly string HexPrimary = "#2C3E50"; // Azul Oscuro
        private static readonly string HexAccent = "#3498DB";  // Azul Brillante
        private static readonly string HexDanger = "#E74C3C";  // Rojo
        private static readonly string HexSuccess = "#27AE60"; // Verde
        private static readonly string HexLight = "#F8F9FA";   // Fondo Gris

        public void GenerateFullReport(string filePath, List<Incidencia> datos)
        {
            // --- 1. PROCESAMIENTO DE DATOS ---

            // KPIs Globales
            int total = datos.Count;
            int criticas = datos.Count(x => x.IncidenceLevel == "Rojo");
            var topProvincia = datos.GroupBy(x => x.Province ?? "N/A")
                                    .OrderByDescending(g => g.Count())
                                    .Select(g => new { Nombre = g.Key, Cantidad = g.Count() })
                                    .FirstOrDefault();

            // KPI: Top Causa (FILTRADO INTELIGENTE)
            // Ignoramos nulos, vacíos o genéricos para mostrar la causa real predominante
            var topCausa = datos
                .Where(x => !string.IsNullOrEmpty(x.Cause)
                            && x.Cause != "Var"
                            && x.Cause != "Otras"
                            && x.Cause != "Desconocida")
                .GroupBy(x => x.Cause)
                .OrderByDescending(g => g.Count())
                .Select(g => new { Nombre = g.Key, Cantidad = g.Count() })
                .FirstOrDefault();

            // Datos Gráfico Donut (Gravedad)
            var datosGravedad = datos.GroupBy(x => x.IncidenceLevel ?? "Otros")
                                   .Select(g => new { Nivel = g.Key, Cantidad = g.Count() })
                                   .OrderByDescending(x => x.Cantidad).ToList();

            // Datos Gráfico Barras (Top 5 Causas)
            var datosCausas = datos.GroupBy(x => x.Cause ?? "Otros")
                                   .Select(g => new { Causa = g.Key, Cantidad = g.Count() })
                                   .OrderByDescending(x => x.Cantidad)
                                   .Take(5)
                                   .ToList();

            // Datos Tabla (Top 20 Carreteras)
            var datosCarreteras = datos.GroupBy(x => x.Road ?? "Urbano")
                                     .Select(g => new { Carretera = g.Key, Total = g.Count() })
                                     .OrderByDescending(x => x.Total)
                                     .Take(20)
                                     .ToList();

            // Datos Tendencia (Últimos 14 días)
            var haceDias = DateTime.Now.Date.AddDays(-13);
            var tendencia = datos.Where(x => x.StartDate.HasValue && x.StartDate.Value.Date >= haceDias)
                                 .GroupBy(x => x.StartDate.Value.Date)
                                 .OrderBy(g => g.Key)
                                 .Select(g => new { Fecha = g.Key.ToString("dd/MM"), Count = (double)g.Count() })
                                 .ToList();

            // --- 2. GENERACIÓN DE GRÁFICOS ---

            byte[] imgTendencia = GenerarAreaChart(tendencia.Select(x => x.Fecha).ToArray(), tendencia.Select(x => x.Count).ToArray());
            byte[] imgGravedad = GenerarDonutChart(datosGravedad);
            byte[] imgCausas = GenerarBarChart(datosCausas);


            // --- 3. MAQUETACIÓN MULTIPÁGINA ---

            Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Size(PageSizes.A4);
                    page.Margin(40);
                    page.PageColor(QColors.White);
                    page.DefaultTextStyle(x => x.FontSize(11).FontFamily(QFonts.SegoeUI));

                    page.Header().Element(ComposeHeader);

                    page.Content().Column(col =>
                    {
                        // === PÁGINA 1: VISIÓN GENERAL ===

                        col.Item().PaddingBottom(20).Text("Resumen Ejecutivo").FontSize(18).SemiBold().FontColor(HexPrimary);

                        // Fila de KPIs
                        col.Item().Row(row =>
                        {
                            row.RelativeItem().Element(e => KpiCard(e, "TOTAL INCIDENCIAS", total.ToString(), HexAccent));
                            row.Spacing(15);
                            row.RelativeItem().Element(e => KpiCard(e, "NIVEL ROJO", criticas.ToString(), HexDanger));
                            row.Spacing(15);
                            row.RelativeItem().Element(e => KpiCard(e, "CAUSA PRINCIPAL", topCausa?.Nombre ?? "N/A", HexSuccess));
                            row.Spacing(15);
                            row.RelativeItem().Element(e => KpiCard(e, "ZONA CRÍTICA", topProvincia?.Nombre ?? "-", HexPrimary));
                        });

                        col.Item().PaddingVertical(30).LineHorizontal(1).LineColor(QColors.Grey.Lighten3);

                        // Gráfico de Tendencia
                        col.Item().Column(c =>
                        {
                            c.Item().Text("Evolución de la Actividad (14 Días)").FontSize(14).SemiBold().FontColor(HexPrimary);
                            c.Item().Text("Tendencia diaria de incidencias registradas en la red.").FontSize(10).FontColor(QColors.Grey.Medium);
                            c.Item().PaddingTop(15).Border(1).BorderColor(QColors.Grey.Lighten4).Padding(10).Image(imgTendencia);
                        });

                        // SALTO DE PÁGINA
                        col.Item().PageBreak();


                        // === PÁGINA 2: ANÁLISIS CUALITATIVO ===

                        col.Item().PaddingBottom(20).Text("Análisis Detallado").FontSize(18).SemiBold().FontColor(HexPrimary);

                        col.Item().Row(row =>
                        {
                            // Izquierda: Gravedad (Donut)
                            row.RelativeItem().Column(c =>
                            {
                                c.Item().Text("Distribución por Severidad").FontSize(14).SemiBold().FontColor(HexPrimary);
                                c.Item().PaddingTop(5).Text("Proporción de alertas según nivel de gravedad.").FontSize(10).FontColor(QColors.Grey.Medium);
                                c.Item().PaddingTop(20).AlignCenter().Image(imgGravedad).FitArea();
                            });

                            row.Spacing(40);

                            // Derecha: Causas (Barras)
                            row.RelativeItem().Column(c =>
                            {
                                c.Item().Text("Principales Causas").FontSize(14).SemiBold().FontColor(HexPrimary);
                                c.Item().PaddingTop(5).Text("Top 5 motivos de incidencia reportados.").FontSize(10).FontColor(QColors.Grey.Medium);
                                c.Item().PaddingTop(20).AlignCenter().Image(imgCausas).FitArea();
                            });
                        });

                        col.Item().PaddingVertical(30).LineHorizontal(1).LineColor(QColors.Grey.Lighten3);

                        // Insights Simulados
                        col.Item().Background(HexLight).Padding(15).Column(c => {
                            c.Item().Text("INSIGHTS AUTOMÁTICOS").FontSize(10).Bold().FontColor(HexAccent);
                            double porcentajeCritico = total > 0 ? ((double)criticas / total) * 100 : 0;
                            c.Item().Text($"Se observa una concentración del {porcentajeCritico:F1}% de incidencias críticas. La provincia de {topProvincia?.Nombre} acumula la mayor carga de trabajo, sugiriendo la necesidad de reforzar recursos en dicha zona.").FontSize(10).Italic().FontColor(HexPrimary);
                        });


                        // SALTO DE PÁGINA
                        col.Item().PageBreak();


                        // === PÁGINA 3: DETALLE DE INFRAESTRUCTURA ===

                        col.Item().PaddingBottom(20).Text("Desglose por Infraestructura").FontSize(18).SemiBold().FontColor(HexPrimary);
                        col.Item().Text("Listado de los 20 puntos con mayor concentración de incidencias acumuladas.").FontSize(10).FontColor(QColors.Grey.Medium);

                        col.Item().PaddingTop(20).Element(e => ComposeTable(e, datosCarreteras));
                    });

                    // Footer Global
                    page.Footer().PaddingTop(20).Row(row => {
                        row.RelativeItem().Column(c => {
                            c.Item().Text("MAVPC Intelligence System").FontSize(10).Bold().FontColor(QColors.Grey.Darken2);
                            c.Item().Text($"Informe ID: {Guid.NewGuid().ToString().Substring(0, 8).ToUpper()}").FontSize(8).FontColor(QColors.Grey.Medium);
                        });
                        row.RelativeItem().AlignRight().Text(x => {
                            x.Span("Página "); x.CurrentPageNumber(); x.Span(" de "); x.TotalPages();
                        });
                    });
                });
            })
            .GeneratePdf(filePath);
        }

        // --- MÉTODOS VISUALES ---

        void ComposeHeader(IContainer container)
        {
            container.PaddingBottom(20).Row(row =>
            {
                row.RelativeItem().Column(c =>
                {
                    c.Item().Text("INFORME ESTRATÉGICO").FontSize(28).ExtraBold().FontColor(HexPrimary);
                    c.Item().Text("Estado de la Red y Seguridad Vial").FontSize(14).FontColor(QColors.Grey.Darken1);
                });
                row.ConstantItem(150).AlignRight().Column(c =>
                {
                    c.Item().Text(DateTime.Now.ToString("dd MMMM yyyy")).FontSize(12).Bold().AlignRight();
                    c.Item().Text("MAVPC HQ").FontSize(10).FontColor(QColors.Grey.Medium).AlignRight();
                });
            });
        }

        void KpiCard(IContainer container, string label, string value, string accentColor)
        {
            container
                .BorderTop(4).BorderColor(accentColor)
                .Background(QColors.White)
                .Padding(15)
                .Column(c => {
                    c.Item().Text(value).FontSize(24).Bold().FontColor(HexPrimary);
                    // CORRECCIÓN: label.ToUpper() es C#, no QuestPDF.
                    c.Item().Text(label.ToUpper()).FontSize(8).SemiBold().FontColor(QColors.Grey.Darken1);
                });
        }

        void ComposeTable(IContainer container, dynamic datosTabla)
        {
            container.Table(table =>
            {
                table.ColumnsDefinition(cols =>
                {
                    cols.ConstantColumn(40); // #
                    cols.RelativeColumn(4);  // Vía
                    cols.RelativeColumn(3);  // Provincia
                    cols.RelativeColumn(2);  // Total
                });

                table.Header(h =>
                {
                    h.Cell().Element(HeaderStyle).Text("#");
                    h.Cell().Element(HeaderStyle).Text("INFRAESTRUCTURA");
                    h.Cell().Element(HeaderStyle).Text("ESTADO");
                    h.Cell().Element(HeaderStyle).AlignRight().Text("TOTAL INC.");
                });

                int i = 1;
                foreach (var item in datosTabla)
                {
                    string bg = (i % 2 == 0) ? QColors.White : HexLight;

                    table.Cell().Element(e => CellStyle(e, bg)).Text(i.ToString()).FontColor(QColors.Grey.Medium);

                    // CORRECCIÓN: Casting explícito a (string) para que .SemiBold() funcione
                    table.Cell().Element(e => CellStyle(e, bg)).Text((string)item.Carretera).SemiBold().FontColor(HexPrimary);

                    table.Cell().Element(e => CellStyle(e, bg)).Text("Monitorizado").FontSize(9).Italic().FontColor(QColors.Grey.Darken1);

                    // CORRECCIÓN: Interpolación o .ToString() para el número
                    table.Cell().Element(e => CellStyle(e, bg)).AlignRight().Text($"{item.Total}").Bold();

                    i++;
                }
            });
        }

        static IContainer HeaderStyle(IContainer c) => c.BorderBottom(2).BorderColor(HexPrimary).Padding(8).DefaultTextStyle(x => x.SemiBold().FontSize(10).FontColor(HexPrimary));
        static IContainer CellStyle(IContainer c, string bg) => c.BorderBottom(1).BorderColor(QColors.Grey.Lighten4).Background(bg).Padding(8).DefaultTextStyle(x => x.FontSize(10));


        // --- GRÁFICOS (SCOTTPLOT 5) ---

        private byte[] GenerarAreaChart(string[] fechas, double[] valores)
        {
            if (valores.Length == 0) return new byte[0];

            ScottPlot.Plot myPlot = new();
            myPlot.FigureBackground.Color = SColors.White;
            myPlot.DataBackground.Color = SColors.White;

            myPlot.Axes.Left.FrameLineStyle.Width = 0;
            myPlot.Axes.Bottom.FrameLineStyle.Width = 0;
            myPlot.Axes.Left.TickLabelStyle.ForeColor = SColor.FromHex("#7F8C8D");
            myPlot.Axes.Bottom.TickLabelStyle.ForeColor = SColor.FromHex("#7F8C8D");

            myPlot.Grid.MajorLineColor = SColor.FromHex("#ECF0F1");
            myPlot.Axes.Bottom.MajorTickStyle.Length = 0;

            var sp = myPlot.Add.Scatter(Generate.Consecutive(valores.Length), valores);
            sp.LineWidth = 3;
            sp.Color = SColor.FromHex(HexAccent);
            sp.MarkerSize = 4;
            sp.MarkerShape = MarkerShape.FilledCircle;

            sp.FillY = true;
            sp.FillYColor = sp.Color.WithAlpha(0.2);

            ScottPlot.TickGenerators.NumericManual tickGen = new();
            for (int i = 0; i < fechas.Length; i++) tickGen.AddMajor(i, fechas[i]);
            myPlot.Axes.Bottom.TickGenerator = tickGen;
            myPlot.Axes.Bottom.TickLabelStyle.Rotation = -45;

            myPlot.Axes.Margins(bottom: 0, top: 0.2);

            return myPlot.GetImageBytes(800, 300, SImageFormat.Png);
        }

        private byte[] GenerarDonutChart(dynamic datos)
        {
            ScottPlot.Plot myPlot = new();
            myPlot.Layout.Frameless();
            myPlot.HideGrid();

            // 1. PALETA SEMÁNTICA (Prioridad)
            var cRojo = SColor.FromHex("#E74C3C");
            var cNaranja = SColor.FromHex("#E67E22");
            var cAmarillo = SColor.FromHex("#F1C40F");
            var cVerde = SColor.FromHex("#2ECC71");
            var cBlanco = SColor.FromHex("#95A5A6");

            // 2. PALETA DE RESERVA (Para todo lo que no coincida, colores bonitos y variados)
            var paletaFallback = new SColor[] {
                SColor.FromHex("#3498DB"), // Azul
                SColor.FromHex("#9B59B6"), // Morado
                SColor.FromHex("#1ABC9C"), // Turquesa
                SColor.FromHex("#34495E"), // Gris Azulado
                SColor.FromHex("#16A085"), // Verde Mar
                SColor.FromHex("#D35400"), // Calabaza
                SColor.FromHex("#8E44AD"), // Violeta
                SColor.FromHex("#2C3E50")  // Azul Noche
            };

            List<PieSlice> slices = new();
            int idx = 0; // Índice para rotar colores de fallback

            foreach (var item in datos)
            {
                string rawNivel = item.Nivel.ToString();
                string cleanLabel = rawNivel;
                SColor colorActual;
                bool semanticoEncontrado = false;

                // 3. LÓGICA DE ASIGNACIÓN
                if (rawNivel.Contains("Rojo", StringComparison.OrdinalIgnoreCase))
                {
                    cleanLabel = "Nivel Rojo"; colorActual = cRojo; semanticoEncontrado = true;
                }
                else if (rawNivel.Contains("Naran", StringComparison.OrdinalIgnoreCase))
                {
                    cleanLabel = "Nivel Naranja"; colorActual = cNaranja; semanticoEncontrado = true;
                }
                else if (rawNivel.Contains("Amar", StringComparison.OrdinalIgnoreCase))
                {
                    cleanLabel = "Nivel Amarillo"; colorActual = cAmarillo; semanticoEncontrado = true;
                }
                else if (rawNivel.Contains("Blan", StringComparison.OrdinalIgnoreCase))
                {
                    cleanLabel = "Nivel Blanco"; colorActual = cBlanco; semanticoEncontrado = true;
                }
                else if (rawNivel.Contains("Verd", StringComparison.OrdinalIgnoreCase) || rawNivel.Contains("Fluido"))
                {
                    cleanLabel = "Nivel Verde"; colorActual = cVerde; semanticoEncontrado = true;
                }
                else
                {
                    // === AQUÍ ESTÁ EL CAMBIO ===
                    // Si no reconocemos el color, usamos uno de la paleta rotatoria
                    // en lugar de usar siempre el mismo azul oscuro.
                    colorActual = paletaFallback[idx % paletaFallback.Length];

                    // Limpiamos la etiqueta si es muy larga
                    if (cleanLabel.Length > 15) cleanLabel = cleanLabel.Substring(0, 12) + "...";
                }

                slices.Add(new PieSlice { Value = item.Cantidad, FillColor = colorActual, Label = null });
                myPlot.Legend.ManualItems.Add(new LegendItem { LabelText = cleanLabel, FillColor = colorActual });

                idx++;
            }

            var pie = myPlot.Add.Pie(slices);
            pie.DonutFraction = 0.6;

            // Borde blanco (si tu versión de ScottPlot lo soporta, si no, borra estas 2 líneas)
            pie.LineStyle.Width = 2;
            pie.LineStyle.Color = SColors.White;

            myPlot.ShowLegend();
            myPlot.Legend.Orientation = Orientation.Vertical;
            myPlot.Legend.Alignment = Alignment.MiddleRight;
            myPlot.Legend.FontSize = 10;
            myPlot.Legend.FontColor = SColor.FromHex("#7F8C8D");
            myPlot.Legend.OutlineStyle.Width = 0;
            myPlot.Legend.BackgroundFill.Color = SColors.Transparent;

            myPlot.Axes.Margins(right: 0.2);

            return myPlot.GetImageBytes(500, 300, SImageFormat.Png);
        }
        private byte[] GenerarBarChart(dynamic datos)
        {
            ScottPlot.Plot myPlot = new();

            // 1. LIMPIEZA TOTAL (Quitamos Frameless para que el texto tenga 'aire')
            myPlot.HideGrid();
            myPlot.FigureBackground.Color = SColors.Transparent;

            // Quitamos las líneas de los ejes pero dejamos que se vea el texto
            myPlot.Axes.Left.FrameLineStyle.Width = 0;
            myPlot.Axes.Bottom.FrameLineStyle.Width = 0;
            myPlot.Axes.Left.TickLabelStyle.IsVisible = false; // Los números ya van arriba de las barras

            List<Bar> bars = new();
            List<Tick> ticks = new();
            int i = 0;

            foreach (var item in datos)
            {
                var bar = new Bar()
                {
                    Position = i,
                    Value = item.Cantidad,
                    FillColor = SColor.FromHex(HexPrimary)
                };
                // El número que ves arriba de la barra
                bar.Label = item.Cantidad.ToString();
                bars.Add(bar);

                // --- EL CAMBIO: NO CORTAMOS EL NOMBRE ---
                string label = item.Causa.ToString();
                ticks.Add(new Tick(i, label));
                i++;
            }

            var barPlot = myPlot.Add.Bars(bars);
            barPlot.ValueLabelStyle.FontSize = 13;
            barPlot.ValueLabelStyle.Bold = true;

            // --- CONFIGURACIÓN DEL EJE X (LOS NOMBRES) ---
            myPlot.Axes.Bottom.TickGenerator = new ScottPlot.TickGenerators.NumericManual(ticks.ToArray());
            myPlot.Axes.Bottom.TickLabelStyle.IsVisible = true;
            myPlot.Axes.Bottom.TickLabelStyle.FontSize = 11;
            myPlot.Axes.Bottom.TickLabelStyle.ForeColor = SColor.FromHex("#2C3E50");

            // Rotamos a -45 grados: Es la única forma de que nombres como "Mantenimiento" 
            // no se pisen con los de al lado.
            myPlot.Axes.Bottom.TickLabelStyle.Rotation = -45;
            myPlot.Axes.Bottom.TickLabelStyle.Alignment = Alignment.MiddleRight;

            // --- EL MARGEN FUNDAMENTAL ---
            // Al dar un 0.4 abajo, reservamos casi la mitad de la imagen para que quepan los nombres
            myPlot.Axes.Margins(bottom: 0.45, top: 0.2);

            return myPlot.GetImageBytes(500, 350, SImageFormat.Png);
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\PdfService.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\TrafficService.cs
============================================================

using MAVPC.Models;
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading.Tasks;

namespace MAVPC.Services
{
    public class TrafficService : ITrafficService
    {
        private readonly HttpClient _httpClient;
        private readonly JsonSerializerOptions _jsonOptions;

        private const string BASE_URL = "https://mavpc.up.railway.app/api/";

        public TrafficService(HttpClient httpClient)
        {
            _httpClient = httpClient;
            _jsonOptions = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true,
                DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
                NumberHandling = JsonNumberHandling.AllowReadingFromString
            };
        }

        // --- MÉTODOS EXISTENTES ---

        public async Task<List<Camara>> GetCamarasAsync()
        {
            try
            {
                return await _httpClient.GetFromJsonAsync<List<Camara>>($"{BASE_URL}camaras", _jsonOptions) ?? new List<Camara>();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error GetCamaras: {ex.Message}");
                return new List<Camara>();
            }
        }

        public async Task<List<Incidencia>> GetIncidenciasAsync()
        {
            // Este llama a /listarActual (Solo lo que está pasando AHORA)
            return await FetchIncidencias($"{BASE_URL}incidencias/listarActual");
        }

        // --- NUEVO MÉTODO: HISTORIAL COMPLETO ---
        public async Task<List<Incidencia>> GetAllIncidenciasAsync()
        {
            // Este llama a /incidencias (Histórico completo para reportes)
            return await FetchIncidencias($"{BASE_URL}incidencias");
        }

        // He refactorizado la lógica de fetch para no repetir código, 
        // ya que ambos endpoints devuelven la misma estructura JSON.
        private async Task<List<Incidencia>> FetchIncidencias(string url)
        {
            try
            {
                var response = await _httpClient.GetAsync(url);
                var jsonString = await response.Content.ReadAsStringAsync();

                if (!response.IsSuccessStatusCode)
                {
                    System.Diagnostics.Debug.WriteLine($"Error HTTP: {response.StatusCode}");
                    return new List<Incidencia>();
                }

                var lista = JsonSerializer.Deserialize<List<Incidencia>>(jsonString, _jsonOptions);

                if (lista != null)
                {
                    // Filtramos latitud 0 o nula para evitar basura en el mapa/reporte
                    return lista.FindAll(x => x.Latitude != null && x.Latitude != 0);
                }

                return new List<Incidencia>();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"ERROR FETCH: {ex.Message}");
                return new List<Incidencia>();
            }
        }

        // --- MÉTODOS DE ESCRITURA ---

        public async Task<bool> AddCamaraAsync(Camara nuevaCamara)
        {
            try
            {
                var response = await _httpClient.PostAsJsonAsync($"{BASE_URL}camaras", nuevaCamara, _jsonOptions);
                return response.IsSuccessStatusCode;
            }
            catch { return false; }
        }

        public async Task<bool> AddIncidenciaAsync(Incidencia nuevaIncidencia)
        {
            try
            {
                var response = await _httpClient.PostAsJsonAsync($"{BASE_URL}incidencias", nuevaIncidencia, _jsonOptions);
                return response.IsSuccessStatusCode;
            }
            catch { return false; }
        }

        public async Task<bool> DeleteCamaraAsync(string id)
        {
            try
            {
                var response = await _httpClient.DeleteAsync($"{BASE_URL}camaras?id={id}");
                return response.IsSuccessStatusCode;
            }
            catch { return false; }
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Services\TrafficService.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Utils\GpsUtils.cs
============================================================

using System;

namespace MAVPC.Utils
{
    public static class GpsUtils
    {
        // Constantes del elipsoide WGS84 (El estándar mundial GPS)
        private const double A = 6378137; // Radio ecuatorial
        private const double E = 0.081819191; // Excentricidad
        private const double K0 = 0.9996; // Factor de escala

        /// <summary>
        /// Convierte coordenadas UTM (X, Y) a Latitud/Longitud.
        /// Asume por defecto Zona 30 Norte (Euskadi/España).
        /// </summary>
        public static (double Lat, double Lon) UtmToLatLng(double x, double y, int zone = 30, bool north = true)
        {
            // 1. Cálculos preliminares
            double e2 = E * E; // Excentricidad al cuadrado
            double e1 = (1 - Math.Sqrt(1 - e2)) / (1 + Math.Sqrt(1 - e2));
            double e1_2 = e1 * e1;
            double e1_3 = e1 * e1 * e1;
            double e1_4 = e1 * e1 * e1 * e1;

            // 2. Ajuste de coordenadas
            // Restamos el "Falso Norte" (0 en hemisferio norte, 10.000.000 en sur)
            double yAdjusted = north ? y : y - 10000000.0;
            // Restamos el "Falso Este" (500.000 metros)
            double xAdjusted = x - 500000.0;

            // 3. Calcular la Latitud "Footprint"
            double m = yAdjusted / K0;
            double mu = m / (A * (1 - e2 / 4 - 3 * e2 * e2 / 64 - 5 * e2 * e2 * e2 / 256));

            double phi1Rad = mu + (3 * e1 / 2 - 27 * e1_3 / 32) * Math.Sin(2 * mu)
                             + (21 * e1_2 / 16 - 55 * e1_4 / 32) * Math.Sin(4 * mu)
                             + (151 * e1_3 / 96) * Math.Sin(6 * mu);

            // 4. Variables auxiliares sobre phi1
            double sinPhi1 = Math.Sin(phi1Rad);
            double cosPhi1 = Math.Cos(phi1Rad);
            double tanPhi1 = Math.Tan(phi1Rad);

            double n1 = A / Math.Sqrt(1 - e2 * sinPhi1 * sinPhi1);
            double t1 = tanPhi1 * tanPhi1;
            double t1_2 = t1 * t1;

            double r1 = A * (1 - e2) / Math.Pow(1 - e2 * sinPhi1 * sinPhi1, 1.5);
            double d = xAdjusted / (n1 * K0);
            double d2 = d * d;
            double d3 = d * d * d;
            double d4 = d * d * d * d;
            double d5 = d * d * d * d * d;
            double d6 = d * d * d * d * d * d;

            // 5. Cálculo final de Latitud
            double latRad = phi1Rad - (n1 * tanPhi1 / r1) * (d2 / 2 - (5 + 3 * t1 + 10 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) - 4 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) - 9 * e2 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2))) * d4 / 24 + (61 + 90 * t1 + 298 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) + 45 * t1_2 - 252 * e2 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) - 3 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2))) * d6 / 720);

            // 6. Cálculo final de Longitud
            double lonRad = (d - (1 + 2 * t1 + (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2))) * d3 / 6 + (5 - 2 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) + 28 * t1 - 3 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) + 8 * e2 * (E * E * Math.Cos(phi1Rad) * Math.Cos(phi1Rad) / (1 - e2)) + 24 * t1_2) * d5 / 120) / cosPhi1;

            // Ajuste por el Meridiano Central de la zona
            // Zona 30 tiene meridiano central en -3 grados, Zona 31 en +3, etc.
            double centralMeridianRad = ((zone * 6 - 180) - 3) * (Math.PI / 180.0);

            // Convertimos a grados
            double lat = latRad * (180.0 / Math.PI);
            double lon = (lonRad + centralMeridianRad) * (180.0 / Math.PI);

            return (lat, lon);
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\Utils\GpsUtils.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\App.xaml
============================================================

<Application x:Class="MAVPC.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             Startup="App_OnStartup">

    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <materialDesign:BundledTheme BaseTheme="Dark" PrimaryColor="Cyan" SecondaryColor="Pink" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesign3.Defaults.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="BoolToVis"/>

            <SolidColorBrush x:Key="NeonCyan" Color="#00F0FF"/>
            <SolidColorBrush x:Key="NeonPink" Color="#FF003C"/>
            <SolidColorBrush x:Key="DarkBg" Color="#0B0E14"/>
            <SolidColorBrush x:Key="PanelBg" Color="#151922"/>

            <Style TargetType="TextBlock">
                <Setter Property="FontFamily" Value="Segoe UI"/>
            </Style>
        </ResourceDictionary>
    </Application.Resources>
</Application>
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\App.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\App.xaml.cs
============================================================

using MAVPC.MVVM.ViewModels;
using MAVPC.MVVM.Views;
using MAVPC.Services;
using Microsoft.Extensions.DependencyInjection;
using QuestPDF.Infrastructure; // <--- IMPORTANTE
using System.Windows;

namespace MAVPC
{
    public partial class App : Application
    {
        private readonly ServiceProvider _serviceProvider;

        public App()
        {
            ServiceCollection services = new ServiceCollection();

            // HTTP Client
            services.AddHttpClient();

            // Servicios
            services.AddSingleton<IAuthService, AuthService>();
            services.AddSingleton<ITrafficService, TrafficService>();

            // --- NUEVO: REGISTRAR EL SERVICIO DE PDF ---
            services.AddSingleton<IPdfService, PdfService>();
            // -------------------------------------------

            // ViewModels
            services.AddSingleton<MainViewModel>();
            services.AddTransient<LoginViewModel>();
            services.AddTransient<DashboardViewModel>(); // Se inyectará IPdfService automáticamente aquí
            services.AddTransient<MapViewModel>();
            services.AddTransient<StatsViewModel>();
            services.AddTransient<UsersViewModel>();

            // Vistas
            services.AddSingleton<MainView>(provider => new MainView
            {
                DataContext = provider.GetRequiredService<MainViewModel>()
            });

            _serviceProvider = services.BuildServiceProvider();
        }

        private void App_OnStartup(object sender, StartupEventArgs e)
        {
            // --- NUEVO: LICENCIA QUESTPDF (Requerido) ---
            QuestPDF.Settings.License = LicenseType.Community;
            // --------------------------------------------

            var mainWindow = _serviceProvider.GetRequiredService<MainView>();
            mainWindow.Show();
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\App.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\AssemblyInfo.cs
============================================================

using System.Windows;

[assembly: ThemeInfo(
    ResourceDictionaryLocation.None,            //where theme specific resource dictionaries are located
                                                //(used if a resource is not found in the page,
                                                // or application resource dictionaries)
    ResourceDictionaryLocation.SourceAssembly   //where the generic resource dictionary is located
                                                //(used if a resource is not found in the page,
                                                // app, or any theme specific resource dictionaries)
)]

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\AssemblyInfo.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MainWindow.xaml
============================================================

<Window x:Class="MAVPC.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:MAVPC"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800">
    <Grid>

    </Grid>
</Window>

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MainWindow.xaml
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MainWindow.xaml.cs
============================================================

using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace MAVPC
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();
        }
    }
}
============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MainWindow.xaml.cs
============================================================

============================================================
ARCHIVO: C:\Users\2dam3\Documents\Retos\MAVPC\Desktop-WPF\MAVPC\MAVPC\MAVPC.csproj
============================================================

<Project Sdk="Microsoft.NET.Sdk">

	<PropertyGroup>
		<OutputType>WinExe</OutputType>
		<TargetFramework>net8.0-windows</TargetFramework>
		<Nullable>enable</Nullable>
		<ImplicitUsings>enable</ImplicitUsings>
		<UseWPF>true</UseWPF>
	</PropertyGroup>

	<ItemGroup>
	  <None Remove="Assets\css\estilos.css" />
	  <None Remove="Assets\js\logica.js" />
	  <None Remove="Assets\mapa.html" />
	</ItemGroup>

	<ItemGroup>
	  <Content Include="Assets\css\estilos.css">
	    <CopyToOutputDirectory>Always</CopyToOutputDirectory>
	  </Content>
	  <Content Include="Assets\js\logica.js">
	    <CopyToOutputDirectory>Always</CopyToOutputDirectory>
	  </Content>
	  <Content Include="Assets\mapa.html">
	    <CopyToOutputDirectory>Always</CopyToOutputDirectory>
	  </Content>
	</ItemGroup>

	<ItemGroup>
		<PackageReference Include="CommunityToolkit.Mvvm" Version="8.2.2" />
		<PackageReference Include="leaflet" Version="0.7.3" />
		<PackageReference Include="LiveCharts.Wpf" Version="0.9.7" />

		<PackageReference Include="MaterialDesignThemes" Version="4.9.0" />

		<PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="8.0.0" />
		<PackageReference Include="Microsoft.Extensions.Http" Version="8.0.0" />
		<PackageReference Include="Microsoft.Web.WebView2" Version="1.0.3796-prerelease" />
		<PackageReference Include="QuestPDF" Version="2025.12.3.1-alpha2" />
		<PackageReference Include="ScottPlot" Version="5.1.57" />
	</ItemGroup>

</Project>
